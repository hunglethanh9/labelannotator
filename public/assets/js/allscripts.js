var segmentationEnabled=!1,singleLayout=!0,classes=[],zoomChangeRequest=0,panChangeRequest=0,showLoader=!1,growthRangeDefault=30,growthRange=growthRangeDefault,viewportHistory=function(){var t={},e=-1;function a(a){if(a.detail){var o=cornerstone.getEnabledElement(a.detail.element);if(o.image){var n=o.image.imageId,s=cornerstone.getViewport(a.detail.element),i={viewport:$.extend(!0,{},s)};t.hasOwnProperty(n)||(t[n]=[]),e+=1,t[n].splice(e,0,i)}}}function o(a,o){var n=cornerstone.getEnabledElement(a).image.imageId,s=t[n][o];cornerstone.setViewport(a,s.viewport),e=o,console.log(t)}return{enable:function(t){$(t).off("cornerstonetoolsaction",a),$(t).on("cornerstonetoolsaction",a);var e={element:t},o=jQuery.Event("cornerstonetoolsaction");o.detail=e,$(t).trigger(o)},disable:function(t){$(t).off("cornerstonetoolsaction",a)},undo:function(t,a){void 0===a&&(a=1);var n=e-a;n<0||(console.log("Undoing "+a+" step(s) to step "+n),o(t,n))},redo:function(a,n){void 0===n&&(n=1);var s=cornerstone.getEnabledElement(a).image.imageId,i=e+n;i>t[s].length||(console.log("Redoing "+n+" step(s) to step "+i),o(a,i))},add:a,reset:function(e){console.log("Clearing state stack"),t={}}}}();String.prototype.format=function(){for(k in a=this,arguments)a=a.replace("{"+k+"}",arguments[k]);return a};const GetQueryParameterByName=function(t,e){e||(e=window.location.href),t=t.replace(/[\[\]]/g,"\\$&");var a=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return a?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null},ConvertToDate=function(t){let e=Date.now();try{e=new Date(1e3*t)}catch{}return e},uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},hexa2rgba=function(t,e){return"rgba("+parseInt(t.slice(-6,-4),16)+","+parseInt(t.slice(-4,-2),16)+","+parseInt(t.slice(-2),16)+","+e+")"},SessionExists=function(){return void 0!==Cookies.get("rtai_session_key")},GetSessionKey=function(){let t=Cookies.get("rtai_session_key");return void 0!==t?t:""},CreateSessionCookie=function(t,e,a){Cookies.set("rtai_session_key",t,{secure:a,expires:ConvertToDate(e),path:""})},GetCsrfCookie=function(){let t=Cookies.get("csrftoken");return void 0!==t?t:""},api=axios.create({baseURL:SERVICE_URL,timeout:5e3,headers:{"X-CSRFToken":GetCsrfCookie()},withCredentials:!0});axios.defaults.headers.post["Content-Type"]="application/json",axios.defaults.headers.put["Content-Type"]="application/json";const loadProjects=async(t,e)=>{let a="/project".format(),o={};try{const t=await api.get(a);o={status:t.status,statusText:t.statusText,data:t.data}}catch(t){handle401(t.response)}return o},postAnnotation=async t=>{let e={};try{const a=await api.post("/cornerstoneannotation",t);e={status:a.status,statusText:a.statusText,data:a.data}}catch(t){handle401(t.response)}return e},updateAnnotation=async(t,e)=>{let a="/cornerstoneannotation/"+t,o={};try{const t=await api.put(a,e);o={status:t.status,statusText:t.statusText,data:t.data}}catch(t){handle401(t.response)}return o},deleteAnnotation=async t=>{let e="/cornerstoneannotation/"+t,a={};try{const t=await api.delete(e);a={status:t.status,statusText:t.statusText,data:t.data}}catch(t){handle401(t.response)}return a},handle401=function(t){if(401===t.status||403===t.status){let t=BASE_URL+"?task="+taskId+"&project="+projectId;window.location.href=SERVICE_URL+"/auth/login?callback="+encodeURIComponent(t)}},updateStudyConfig=async t=>{let e="/task/{0}/job/{1}".format(taskId,projectId),a={};try{const o=await api.put(e,t);a={status:o.status,statusText:o.statusText,data:o.data}}catch(t){handle401(t.response)}return a};let enabledElement;function setupAnnotationHandler(t){enabledElement=t,$(t).on("cornerstonetoolsenddrawing",function(t){let e=t.detail.type,a=t.detail.currentTool,o=t.detail.modifying;enabledElement=t.detail.element,o?updateAnnotationData(enabledElement,e,t.detail.id):($(".create-annotation-block").attr("tool-data-index",a),$(".create-annotation-block").attr("tool-type",e),$(".create-annotation-block").attr("data-annotation-tool",t.id),$(".create-annotation-block").slideDown())})}function handleAnnotationOnImageIndexChange(t,e){let a=e.instances,o=e.currentImageIdIndex,n=a[o]?a[o]:void 0,s=!0;if(n){var i=n.annotations;if(n.annotationLoaded||(s=!1,i.length>0&&(e.instances[e.currentImageIdIndex].annotationLoaded=!0,cornerstoneTools.removeToolState(t,"stack",e),cornerstoneTools.addToolState(t,"stack",e))),$(".grid-select").find("div.active").length<=1)if(i.length>0){$(".ants-list-group").empty();for(var r=0;r<i.length;r++){let a=i[r];if(a.toolData.color=a.selectedColor,a.toolData.fillStyle=hexa2rgba(a.selectedColor,.3),!s)switch(a.toolName){case"rectangleRoi":cornerstoneTools.addToolState(t,"rectangleRoi",a.toolData);break;case"freehand":cornerstoneTools.addToolState(t,"freehand",a.toolData);break;case"2dgrowthtool":cornerstoneTools.addToolState(t,"2dgrowthtool",a.toolData);break;case"segmentationtool":cornerstoneTools.addToolState(t,"segmentationtool",a.toolData)}a.selectedColor=a.selectedColor.slice(0,7);var l='<li class="ants-list-item" data-annotation-type="'+a.toolName+'" data-annotation-id="'+a.id+'"  ><div class="ant-header" style="background: '+a.selectedColor+'"><div class="ant-title"><p>Class: <strong>'+a.annotationClass+'</strong></p></div><div class="ant-delete" data-annotation-tool="'+a.toolData.id+'" tool-data-index="'+a.toolDataIndex+'"><img src="assets/images/a-delete.svg" alt="Delete" /></div></div><div class="ant-info" style="background: '+hexa2rgba(a.selectedColor,.8)+'"><p><strong>'+a.annotationName+"</strong></p><p>Notes:<br />"+a.annotationDescription+"</p></div></li>";$(".ants-list-group").prepend(l),"2dgrowthtool"===a.toolName?setupGrowthToolLawyer(t,a.toolData.data,a.selectedColor):"segmentationtool"===a.toolName&&setupAnnotationLayer(t,a.toolData.data,a.selectedColor),"2dgrowthtool"!==a.toolName&&"segmentationtool"!==a.toolName||replicateOnAllImages(t,e,a,o)}$("#annotations_list").removeClass("hide")}else $(".ants-list-group").empty(),$("#annotations_list").addClass("hide");else{$(".ants-list-group").empty(),$("#annotations_list").addClass("hide");var c=$(t).parent(".viewportWrapper").find(".small-annotation-list");if($(c).find("ul").empty(),i.length>0){var d=i.length<2?i.length:2;for(r=0;r<d;r++){let e=i[r];l='<li data-annotation-type="'+e.toolName+'" data-annotation-id="'+e.id+'" style="background: '+e.selectedColor+'"><p>'+e.annotationName+'</p><div class="delete-annotation" data-annotation-tool="'+e.toolData.id+'" tool-data-index="'+e.toolDataIndex+'"><img src="assets/images/small-delete.svg" alt="Delete"></div></li>';$(c).find("ul").prepend(l),"2dgrowthtool"===e.toolName?setupGrowthToolLawyer(t,e.toolData.data,e.selectedColor):"segmentationtool"===e.toolName&&setupAnnotationLayer(t,e.toolData.data,e.selectedColor)}if(i.length>2){var g='<li class = "more-annotations"><p> +'+(i.length-2)+" more </p></li>";$(c).find("ul").append(g)}var u=$(t).parent(".viewportWrapper").find(".overlay"),h=$(u[2]).find("div"),m=$(u[3]).find("div");$(h).parent().css({bottom:"40px"}),$(m).parent().css({bottom:"40px"}),$(c).show()}else{u=$(t).parent(".viewportWrapper").find(".overlay"),h=$(u[2]).find("div"),m=$(u[3]).find("div");$(h).parent().css({bottom:"0px"}),$(m).parent().css({bottom:"0px"}),$(c).find("ul").empty(),$(c).hide()}}}}function replicateOnAllImages(t,e,a,o){for(var n=0;n<e.instances.length;++n)if(n!=o){for(var s=!1,i=0;i<e.instances[n].annotations.length;++i)if(e.instances[n].annotations[i].annotationClass===a.annotationClass){s=!0;break}s||(newAnnotation=Object.assign({},a),newAnnotation.toolData={id:uuidv4(),data:[]},newAnnotation.id=uuidv4(),e.instances[n].annotations.push(newAnnotation))}}function resetAnnotationFields(){$("#annotation_name").val(""),$("#annotation_description").val("")}function validateAnnotationFields(){var t=!0;return $("#classSelected").val()?$(".ai-form-annotation").removeClass("form-required"):($(".ai-form-annotation").addClass("form-required"),t=!1),$("#annotation_name")[0].checkValidity()?$("#annotation_name").removeClass("form-required"):($("#annotation_name").addClass("form-required"),t=!1),$("#annotation_description")[0].checkValidity()?$("#annotation_description").removeClass("form-required"):($("#annotation_description").addClass("form-required"),t=!1),$("#selectedColor").val()?$(".selected-color").removeClass("form-required"):($(".selected-color").addClass("form-required"),t=!1),t}function addAnnotationToView(t,e){if($(".grid-select").find("div.active").length<=1){t.selectedColor=t.selectedColor.slice(0,7);var a='<li class="ants-list-item" data-annotation-type="'+t.toolName+'" data-annotation-id="'+t.id+'"  ><div class="ant-header" style="background: '+t.selectedColor+'"><div class="ant-title"><p>Class: <strong>'+t.annotationClass+'</strong></p></div><div class="ant-delete" data-annotation-tool="'+t.toolData.id+'" tool-data-index="'+t.toolDataIndex+'"><img src="assets/images/a-delete.svg" alt="Delete" /></div></div><div class="ant-info" style="background: '+hexa2rgba(t.selectedColor,.8)+'"><p><strong>'+t.annotationName+"</strong></p><p>Notes:<br />"+t.annotationDescription+"</p></div></li>";$(".ants-list-group").prepend(a),$("#annotations_list").removeClass("hide").slideDown()}else{$(".ants-list-group").empty(),$("#annotations_list").addClass("hide");var o=$(enabledElement).parent(".viewportWrapper").find(".small-annotation-list");a='<li style="background: '+t.selectedColor+'"><p>'+t.annotationName+'</p><div class="delete-annotation" tool-data-index="'+t.toolDataIndex+'"><img src="assets/images/small-delete.svg" alt="Delete"></div></li>';$(o).find("ul").prepend(a);var n=$(enabledElement).parent(".viewportWrapper").find(".overlay"),s=$(n[2]).find("div"),i=$(n[3]).find("div");$(s).parent().css({bottom:"40px"}),$(i).parent().css({bottom:"40px"}),$(o).show()}$(".create-annotation-block").slideUp()}function updateAnnotationData(t,e,a){let o=cornerstoneTools.getToolState(t,"stack").data[0],n=o.instances,s=o.currentImageIdIndex,i=n[s]?n[s]:void 0;if(i){let n=i.cornerstoneAnnotationId;var r=i.annotations;if(r.length>0){var l=cornerstoneTools.getToolState(t,[e]);if(l.data&&l.data.length>0){let e=jQuery.grep(l.data,function(t,e){return t.id===a});for(var c=0;c<r.length;c++)if(r[c].toolData.id===a){o.instances[s].annotations[c].toolData=e[0],cornerstoneTools.removeToolState(t,"stack",o),cornerstoneTools.addToolState(t,"stack",o);let a={seriesId:o.seriesId,instanceId:o.instances[s].instanceId,jsonstring:JSON.stringify(o.instances[s].annotations)};const i=JSON.stringify(a);updateAnnotation(n,i)}}}}}$("#annotation_add").on("click",function(t){var e=$(".create-annotation-block").attr("tool-data-index"),a=$(".create-annotation-block").attr("tool-type");if(validateAnnotationFields()){let t=$("#classSelected").val(),n=$("#annotation_name").val(),s=$("#annotation_description").val(),i=$("#selectedColor").val(),r=cornerstoneTools.getToolState(enabledElement,"stack").data[0],l=r.currentImageIdIndex,c=r.instances[l].cornerstoneAnnotationId;var o=cornerstoneTools.getToolState(enabledElement,[a]);if("2dgrowthtool"==a?updateGrowthColor(i,o.data[e].data):"segmentationtool"==a&&updateSegmentationColor(i,o.data[e].data),o.data&&o.data.length>0){let d={id:uuidv4(),annotationClass:t,annotationName:n,annotationDescription:s,selectedColor:i,toolName:a,toolData:o.data[e],toolDataIndex:e,annotatedOn:Date.now()};d.toolData.color=d.selectedColor,d.toolData.fillStyle=hexa2rgba(d.selectedColor,.3),addAnnotationToView(d,e),r.instances[l].annotations.push(d),"2dgrowthtool"!==a&&"segmentationtool"!==a||replicateOnAllImages(enabledElement,r,d,l),cornerstoneTools.removeToolState(enabledElement,"stack",r),cornerstoneTools.addToolState(enabledElement,"stack",r);let g={seriesId:r.seriesId,instanceId:r.instances[l].instanceId,jsonstring:JSON.stringify(r.instances[l].annotations)};const u=JSON.stringify(g);if(c)updateAnnotation(c,u);else{c=postAnnotation(u).id,r.instances[l].cornerstoneAnnotationId=c}resetAnnotationFields()}}cornerstone.updateImage(enabledElement)}),$(document).on("click touchstart",".cancel-annotation",function(){var t=$(".create-annotation-block").attr("tool-data-index"),e=$(".create-annotation-block").attr("tool-type");let a=cornerstoneTools.getToolState(enabledElement,e).data[t];cornerstoneTools.removeToolState(enabledElement,e,a),cornerstone.updateImage(enabledElement),"2dgrowthtool"!==e&&"segmentationtool"!==e||clearAnnotation(e,a),$(this).parents(".create-annotation-block").slideUp(),resetAnnotationFields()}),$(document).on("click touchstart",".ant-delete",function(){var t=$(this).parents("li").attr("data-annotation-type"),e=$(this).attr("data-annotation-tool"),a=$(this).parents("li").attr("data-annotation-id");let o=cornerstoneTools.getToolState(enabledElement,t);if(o&&o.data&&o.data.length>0){let n=jQuery.grep(o.data,function(t,a){return t.id===e});if(n&&n.length>0){cornerstoneTools.removeToolState(enabledElement,t,n[0]);let e=cornerstoneTools.getToolState(enabledElement,"stack").data[0],o=e.instances,s=e.currentImageIdIndex,i=o[s]?o[s]:void 0;if(i){let o=jQuery.grep(i.annotations,function(t,e){return t.id===a});if(o){for(let t=0;t<i.annotations.length;t++)o[0].id===e.instances[s].annotations[t].id&&e.instances[s].annotations.splice(t,1);cornerstoneTools.removeToolState(enabledElement,"stack",e),cornerstoneTools.addToolState(enabledElement,"stack",e),"2dgrowthtool"!==t&&"segmentationtool"!==t||clearAnnotation(t,o[0].toolData);let a={seriesId:e.seriesId,instanceId:e.instances[s].instanceId,jsonstring:JSON.stringify(e.instances[s].annotations)};const n=JSON.stringify(a);updateAnnotation(e.instances[s].cornerstoneAnnotationId,n)}}cornerstone.updateImage(enabledElement),$(this).parents(".ants-list-item").remove(),0==$(".ants-list-group li").length&&$("#annotations_list").addClass("hide")}}}),$(document).on("click touchstart",".delete-annotation",function(){var t=$(this).parents("li").attr("data-annotation-id"),e=$(this).parents("li").attr("data-annotation-type"),a=$(this).parents(".viewportWrapper"),o=$(this).parents(".viewportWrapper").find(".viewport")[0],n=cornerstone.getEnabledElement(o);let s=$(this).attr("data-annotation-tool"),i=cornerstoneTools.getToolState(n.element,e);if(i&&i.data&&i.data.length>0){let o=jQuery.grep(i.data,function(t,e){return t.id===s});if(o&&o.length>0){cornerstoneTools.removeToolState(n.element,e,o[0]);let s=cornerstoneTools.getToolState(n.element,"stack").data[0],i=s.instances,d=s.currentImageIdIndex,g=i[d]?i[d]:void 0;if(g){let a=jQuery.grep(g.annotations,function(e,a){return e.id===t});if(a){for(let t=0;t<g.annotations.length;t++)a[0].id===s.instances[d].annotations[t].id&&s.instances[d].annotations.splice(t,1);cornerstoneTools.removeToolState(n.element,"stack",s),cornerstoneTools.addToolState(n.element,"stack",s),"2dgrowthtool"!==e&&"segmentationtool"!==e||clearAnnotation(e,a[0].toolData)}}if(cornerstone.updateImage(n.element),$(this).parents("li").remove(),0==$(a).find(".sm-anno-ul li").length){var r=$(a).find(".overlay"),l=$(r[2]).find("div"),c=$(r[3]).find("div");$(l).parent().css({bottom:"0px"}),$(c).parent().css({bottom:"0px"}),$(a).find(".small-annotation-list").hide()}}}}),$(document).on("click touchstart",".ant-edit",function(){window.segmentationEditable?window.segmentationEditable=!1:window.segmentationEditable=!0});var segmentedData,svgimg,canvasForSegmentation,contextSegmentation,imageViewer1,canvasForAnnotation,contextAnnotation,svgimgann,annImageData,canvasForGrowth,contextGrowth,svgimggrowth,growthImageData,mouseDown=!1,lastMousePosition={},lastMove="";function setupViewport(t,e,a){function o(t){let e=!0;return!function(t){var e=0,a=0;if(void 0!==lastMousePosition.x&&(e=lastMousePosition.x-t.clientX,a=lastMousePosition.y-t.clientY,Math.abs(e)>=Math.abs(a)&&e>0))return!0;return!1}(t)?!function(t){var e=0,a=0;if(void 0!==lastMousePosition.x&&(e=lastMousePosition.x-t.clientX,a=lastMousePosition.y-t.clientY,Math.abs(e)>=Math.abs(a)&&e<0))return!0;return!1}(t)?"left"==lastMove?e=!1:"right"==lastMove&&(e=!0):(e=!0,lastMove="right"):(e=!1,lastMove="left"),e}cornerstone.displayImage(t,a),void 0!==e.frameRate&&cornerstone.playClip(t,e.frameRate),cornerstoneTools.mouseInput.enable(t),cornerstoneTools.mouseWheelInput.enable(t),cornerstoneTools.touchInput.enable(t),cornerstoneTools.addStackStateManager(t,["playClip"]),cornerstoneTools.addToolState(t,"stack",e),cornerstoneTools.stackScrollWheel.activate(t),cornerstoneTools.stackPrefetch.enable(t),$(t).on("click",function(e){var a=t.getElementsByClassName("cornerstone-canvas");a.length>0&&window.segmentationEnabled&&(null==lastMousePosition||0==lastMousePosition.updated)&&updateIfActive(e,a[0],t,window.segmentationEnabled),lastMousePosition={x:e.clientX,y:e.clientY,updated:!1}}),$(t).on("mousedown",function(e){window.showLoader&&(document.getElementById("loader").className="loader1"),mouseDown=!0;var a=t.getElementsByClassName("cornerstone-canvas");a.length>0&&window.segmentationEnabled&&updateIfActive(e,a[0],t,window.segmentationEnabled),lastMousePosition={x:e.clientX,y:e.clientY,updated:!1}}),$(t).on("mousemove",function(e){if(mouseDown){var a=t.getElementsByClassName("cornerstone-canvas");let n=o(e);!0===updateIfActive(e,a[0],t,n)&&(mouseDown=!1),lastMousePosition={x:e.clientX,y:e.clientY,updated:!0}}}),$(t).on("mouseup",function(e){if(console.log("up "+mouseDown+" "+e.clientX+" "+e.clientY+" "+lastMousePosition.x+" "+lastMousePosition.y+" "+lastMousePosition.updated),mouseDown){var a=t.getElementsByClassName("cornerstone-canvas");let n=o(e);lastMousePosition.x-e.clientX==0&&lastMousePosition.y-e.clientY==0&&1==lastMousePosition.updated||updateIfActive(e,a[0],t,n),mouseDown=!1,lastMove=""}lastMousePosition={x:e.clientX,y:e.clientY,updated:!0}})}function displayThumbnail(t,e,a,o,n){$(t).find(".data-list-items").each(function(){$(this).removeClass("active")}),$(e).addClass("active"),cornerstone.getEnabledElement(a).image&&(cornerstoneTools.stopClip(a),cornerstoneTools.stackScroll.disable(a),cornerstoneTools.stackScroll.enable(a)),cornerstone.loadAndCacheImage(o.imageIds[0]).then(function(t){n&&n.call(t,a,o),viewportHistory.enable(a);var e=cornerstoneTools.getToolState(a,"stack");e.data[0]=o,e.data[0].currentImageIdIndex=0;var s=cornerstone.getDefaultViewport(a,t);s.scale=window.editorConfig.zoom,window.editorConfig.pan&&(s.translation.x=window.editorConfig.pan.x,s.translation.y=window.editorConfig.pan.y),s.voi.windowWidth=window.editorConfig.contrast,s.voi.windowCenter=window.editorConfig.brightness,cornerstone.displayImage(a,t,s),cornerstone.fitToWindow(a),cornerstoneTools.stackPrefetch.enable(a),void 0!==o.frameRate&&cornerstoneTools.playClip(a,o.frameRate);cornerstoneTools.freehand.setConfiguration({mouseLocation:{handles:{start:{highlight:!0,active:!0}}},keyDown:{shift:!1,ctrl:!1,alt:!1},activePencilMode:!0,spacing:5,activeHandleRadius:3,completeHandleRadius:6,alwaysShowHandles:!1,invalidColor:"crimson",modifying:!1,movingTextBox:!1,currentHandle:0,currentTool:-1,isFreehand:!0,showTextbox:!1}),cornerstoneTools.freehand.enable(a),cornerstoneTools.rectangleRoi.enable(a),$(".data-list li").removeClass("disabled")})}async function loadStudy(t,e,a,o){let n=await loadProjects(a,o);if(200===n.status){window.editorConfig=n.data.editor,window.studyConfig=n.data;let a=n.data.images;if(a.classes=n.data.classes,a.classes){for(var s in a.classes)if(a.classes.hasOwnProperty(s)){var i=a.classes[s];classes.push({class:s,color:i.color})}$("#annotationClasses").empty(),$("#selectedClass").html("Selected Class: None");let t=classes.length>5?5:classes.length;for(var r=0;r<t;r++){let t='<li data-class="'+classes[r].class+'" data-color="'+classes[r].color+'" style="background:'+classes[r].color+'">'+classes[r].class+"</li>";$("#annotationClasses").append(t)}if(editorConfig.selectedClass){let t=classes.find(t=>t.class==editorConfig.selectedClass);t&&($('#annotationClasses li[data-class="'+t.class+'"]').addClass("active"),$('.annts_sel_class_block ul li[data-class="'+t.class+'"]').addClass("active"),$("#selectedClass").html("Selected Class: <span>"+t.class+"</span>"),$("#selectedColor").val(t.color),$("#classSelected").val(t.class),$("#select_annotation_class").attr("data-class",t.class),$("#select_annotation_class").attr("data-color",t.color),$(".ai-form-annotation").css({"background-color":t.color}),$(".ai-form-annotation").html(t.class?t.class:"None"))}if(classes.length>5){let t='<li class="more_ants_btn" style="background: #8e8e8e">More..</li>';$("#annotationClasses").append(t)}for(r=0;r<classes.length;r++){let t='<li data-class="'+classes[r].class+'" data-color="'+classes[r].color+'" style="background:'+classes[r].color+'">'+classes[r].class+"</li>";$(".annts_sel_class_block ul").append(t)}let e='<li class="more_ants_btn" style="background: #8e8e8e">More..</li>';$("#annotationClasses").append(e);for(r=0;r<classes.length;r++){let t='<option value="'+classes[r].class+'">'+classes[r].class+"</option>";$("#export_annotation_class").append(t)}}$(document).on("click","#annotationClasses li",function(){if(!$(this).hasClass("more_ants_btn")){$("#annotationClasses li").removeClass("active"),$(this).addClass("active");let t=$(this).attr("data-class");$('.annts_sel_class_block ul li[data-class="'+t+'"]').addClass("active"),$("#selectedClass").html("Selected Class: <span>"+t+"</span>"),$("#selectedColor").val($(this).attr("data-color")),$("#classSelected").val($(this).attr("data-class")),$(".ai-form-annotation").css({"background-color":$(this).attr("data-color")}),$(".ai-form-annotation").html($(this).attr("data-class")?$(this).attr("data-class"):"None")}}),$(document).on("click",".annts_sel_class_block ul li",function(){$(".annts_sel_class_block ul li").removeClass("active"),$(this).addClass("active");let t=$(this).attr("data-class");$("#select_annotation_class").attr("data-class",t),$("#select_annotation_class").attr("data-color",$(this).attr("data-color"))}),$(document).on("click",".ai-form-annotation, .more_ants_btn",function(){if($("#annotationClasses li.active")){let t=$("#annotationClasses li.active").attr("data-class");$(".annts_sel_class_block ul li").removeClass("active"),$('.annts_sel_class_block ul li[data-class="'+t+'"]').addClass("active")}$(".annts_sel_class_block").show()}),$(document).on("click","#cancel_annotation_class",function(){if($("#annotationClasses li.active")){let t=$("#annotationClasses li.active").attr("data-class");$(".annts_sel_class_block ul li").removeClass("active"),$('.annts_sel_class_block ul li[data-class="'+t+'"]').addClass("active")}$(".annts_sel_class_block").hide()}),$(document).on("click","#select_annotation_class",function(){$("#annotationClasses li").removeClass("active"),$(this).addClass("active");let t=$(this).attr("data-class");$("#selectedColor").val($(this).attr("data-color")),$("#classSelected").val($(this).attr("data-class")),$(".ai-form-annotation").css({"background-color":$(this).attr("data-color")}),$(".ai-form-annotation").html($(this).attr("data-class")?$(this).attr("data-class"):"None"),$('#annotationClasses li[data-class="'+t+'"]').addClass("active"),$("#selectedClass").html("Selected Class: <span>"+t+"</span>"),$(".annts_sel_class_block").hide(),1==window.setGrowthToolClassSelection&&(window.setGrowthToolClassSelection=!1,setAnnotationData($(this).attr("targetelement"),$(this).attr("newdata"),$(this).attr("toolType")))}),$("#ai-study-description").html(a.studyDescription);var l=new ImageViewer(t,e);function c(){$(".viewport").first().addClass("viewport-active"),l.forEachElement(function(t){cornerstone.enable(t),$(t).droppable({drop:function(t,e){var a=e.helper.clone().attr("data-stack-index");w($(this).data("index"),a)}})})}l.setLayout("1x1"),setupButtons(window.segmentationEnabled,l),$(t).find(".grid-select .grid-list").click(function(){$(".data-edit li").removeClass("active");var t=$(this).attr("data-value"),e=[];switch(l.forEachElement(function(a,o,n){isNaN($(a).data("useStack"))||e.push($(a).data("useStack")),"1x1"!==t?viewportHistory.disable(a):viewportHistory.enable(a)}),$(this).attr("data-order-number")){case"1":$(".grid-list").removeClass("active"),$(".grid-list.one").addClass("active"),window.singleLayout=!0;break;case"2":$(".grid-list.one, .grid-list.two").addClass("active"),$(".grid-list.three, .grid-list.four").removeClass("active"),window.singleLayout=!1;break;case"3":$(".grid-list.one, .grid-list.three").addClass("active"),$(".grid-list.two, .grid-list.four").removeClass("active"),window.singleLayout=!1;break;case"4":$(".grid-list").addClass("active"),window.singleLayout=!1}if(l.setLayout(t),"1x1"==t||(window.segmentationEnabled=!1),c(),v(),e.length>0){e=e.slice(0,l.viewports.length);var a=0;e.forEach(function(t){w(a++,t)})}$(this).parents("li").removeClass("active"),$(this).parents(".opt-sub-list").slideUp()});var d=0;a.seriesList.forEach(function(t){var e={seriesDescription:t.seriesDescription,stackId:t.seriesNumber,imageIds:[],instances:[],seriesIndex:d,currentImageIdIndex:0,frameRate:t.frameRate,seriesId:t.seriesId,seriesDescription:t.seriesDescription};if(void 0!==t.numberOfFrames)for(var a=t.numberOfFrames,o=0;o<a;o++){var n=t.instanceList[0].imageId+"?frame="+o;"http"!==n.substr(0,4)&&(n=n),e.imageIds.push(n)}else t.instanceList.forEach(function(t){var a=t.imageId,o=t.instanceId,n=t.cornerstoneAnnotationId,s=[];t.annotations&&(s=t.annotations),e.instances.push({instanceId:o,annotations:s,annotationLoaded:!1,cornerstoneAnnotationId:n}),e.imageIds.push(a)});d++,l.stacks.push(e)});var g=$(t).find(".imageViewer")[0],u=($(g).find(".viewportWrapper")[0],$(".ai-container").find(".left-data")[0]),h=$(t).find(".data-main-images")[0];$(h).width();c();var m=$(t).find(".thumbnails")[0];function w(t,e){l.stacks[e].imageIds[0];var o=l.getElement(t);$(o).data("waiting")&&(l.viewports[t].find(".overlay-text").remove(),$(o).data("waiting",!1)),$(o).data("useStack",e),displayThumbnail(m,$(m).find(".data-list-items")[e],o,l.stacks[e],function(t,e){$(t).data("setup")||(setupViewport(t,e,this),setupViewportOverlays(t,a),$(t).data("setup",!0),setupAnnotationHandler(t))})}function v(){var e=$(t).find(".data-main-images")[0];$(m).height("100%");$(e).height(),$(e).width();$(m).height("100%"),$(u).css({height:"100%"}),$(g).css({height:$(u).height()-$(u).find(".data-options:eq(0)").height()}),l.forEachElement(function(t,e){if(cornerstone.resize(t,!0),$(t).data("waiting")){var a=e.find(".overlay-text");a.length<1&&(a=$('<div class="overlay overlay-text">Please drag a stack onto here to view images.</div>').appendTo(e));var o=e.width()/2,n=e.height()/2;a.css({top:n,left:o-a.width()/2})}}),window.segmentationEnabled&&(console.log("redrawSegmentation"),hideSegmentation(element))}l.stacks.forEach(function(t,e){var a='<li class="data-list-items"oncontextmenu="return false"unselectable="on"onselectstart="return false;"onmousedown="return false;" data-stack-index="'+e+'"><div class="dli-thumb"oncontextmenu="return false"unselectable="on"onselectstart="return false;"onmousedown="return false;"></div><div class="dli-caption"><p>'+t.seriesDescription+"</p></div></li>",o=$(a).appendTo(m),n=$(o).find("div")[0];cornerstone.enable(n),cornerstone.loadAndCacheImage(l.stacks[t.seriesIndex].imageIds[0]).then(function(e){0===t.seriesIndex&&$(o).addClass("active"),cornerstone.displayImage(n,e),$(o).draggable({helper:"clone",scroll:!1,zIndex:"5000"})}),$(o).on("click touchstart",function(){$(".data-list li").removeClass("active"),w(0,e)}).data("stack",e)}),$(window).resize(function(){v()}),v(),l.isSingle()&&w(0,0)}}var getClickOffset=function(t,e){var a=getClickPos(t,e),o=a[0];return 4*(a[1]*canvasForSegmentation.width+o)},getClickPos=function(t,e){var a=e,o=a.getBoundingClientRect(),n=window,s=document.documentElement,i=o.left+(n.pageXOffset||s.scrollLeft)-(s.clientLeft||0),r=o.top+(n.pageYOffset||s.scrollTop)-(s.clientTop||0),l=Math.round((t.pageX-i+a.scrollLeft)*(a.offsetWidth/a.scrollWidth)),c=Math.round((t.pageY-r+a.scrollTop)*(a.offsetHeight/a.scrollHeight));return[l=Math.max(Math.min(l,e.width-1),0),c=Math.max(Math.min(c,e.height-1),0)]},getAnnotationData=function(t,e){let a=$("#classSelected").val();if(!a||""==a)return null;let o=cornerstoneTools.getToolState(t,"stack").data[0],n=o.currentImageIdIndex,s=o.instances[n].annotations;for(var i=0;i<s.length;++i){let t=s[i];if(t.toolName==e){if(t.annotationClass==a)return t}}return null},showClassPickerDialog=async function(t,e,a){window.setGrowthToolClassSelection=!0,$(".annts_sel_class_block").attr("targetelement",t),$(".annts_sel_class_block").attr("newdata",e),$(".annts_sel_class_block").attr("toolType",a),$(".annts_sel_class_block").show()},setAnnotationData=function(t,e,a){let o=cornerstoneTools.getToolState(t,"stack").data[0],n=o.currentImageIdIndex,s=$("#classSelected").val();if(!s||""==s)return null;let i=o.instances[n].annotations;for(var r=0;r<i.length;++r){let o=i[r];if(o.toolName==a){o.annotationClass;s==o.annotationClass&&(o.toolData.data=e.data,updateAnnotationData(t,a,o.toolData.id))}}},displayAnnotationData=function(t,e,a,o,n,s){for(var i=0;i<e.length;i++){let l=e[i][0],c=e[i][1];var r=c*annImageData.width+l;r*=4,o.includes(r)||(o.push(r),t[r+0]==s.r&&t[r+1]==s.g&&t[r+2]==s.b||!n?t[r+0]==s.r&&t[r+1]==s.g&&t[r+2]==s.b&&(t[r+3]=128,a.push([l,c])):(t[r+0]=s.r,t[r+1]=s.g,t[r+2]=s.b,t[r+3]=128,a.push([l,c])))}return t};const growAnnotation=function(t,e,a,o,n){var s=getAnnotationData(a,"2dgrowthtool"),i={r:255,g:0,b:0},r=[];s?(r=s.toolData.data,i=hexToRGB(s.selectedColor)):(r=[],i={r:255,g:0,b:0});var l=getClickPos(t,e),c=cornerstone.canvasToPixel(a,{x:l[0],y:l[1]});c.x=Math.floor(c.x),c.y=Math.floor(c.y);var d=[];d.push([c.x,c.y]);var g=generateGrowthRegion(d),u=[],h=[];if(o)r=r.concat(g),growthImageData.data.set(displayGrowthData(growthImageData.data,r,u,h,i,o));else{growthImageData.data.set(displayGrowthData(growthImageData.data,g,[],h,i,o));for(var m=0;m<r.length;m++){let t=r[m][0];var w=r[m][1]*growthImageData.width+t;w*=4,h.includes(w)||u.push(r[m])}}if(contextGrowth.putImageData(growthImageData,0,0),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")),n(),!s&&o){let t=uuidv4(),e=0,o=cornerstoneTools.getToolState(a,"2dgrowthtool");o&&o.data.length>0&&("block"===$(".create-annotation-block")[0].style.display?(e=o.data.length-1,t=o.data[e].id,u=o.data[e].data.concat(u)):e=o.data.length);let n={id:t,data:u};return o&&e!==o.data.length||cornerstoneTools.addToolState(a,"2dgrowthtool",n),$(".create-annotation-block").attr("tool-type","2dgrowthtool"),$(".create-annotation-block").attr("tool-data-index",e),$(".create-annotation-block").slideDown(),!0}{let t=$("#classSelected").val();if(t&&""!=t){s.toolData.data=u;let t=cornerstoneTools.getToolState(a,"2dgrowthtool");for(m=0;m<t.data.length;++m)if(t.data[m].id===s.toolData.id){t.data[m].data=u;break}updateAnnotationData(a,"2dgrowthtool",s.toolData.id)}else showClassPickerDialog(a,toolData,"2dgrowthtool")}return!1};var boolIsUpdating=0,updateIfActive=function(t,e,a,o){if(!window.segmentationEditable)return!1;try{if($("#growthtool").hasClass("active")){return growAnnotation(t,e,a,o,function(){$("#loader").hasClass("hide")||$("#loader").addClass("hide")})}if(!segmentedData)return!1;var n=getClickOffset(t,e),s=_getEncodedLabel(superpixel,n),i=pixelIndex[s],r=annImageData.data;annotation=getAnnotationData(a,"2dgrowthtool"),annotation?(oldGrowthToolData=annotation.toolData.data,drawColor=hexToRGB(annotation.selectedColor)):(oldGrowthToolData=[],drawColor={r:255,g:0,b:0}),newGrowthToolData=[];var l=[];if(this.currentPixels=i,null!==this.currentPixels){for(h=0;h<i.length;++h){var c=(n=i[h])/4%segmentedData.imageData.width,d=Math.floor(n/4/segmentedData.imageData.width),g=cornerstone.canvasToPixel(a,{x:c,y:d});g.x=Math.floor(g.x),g.y=Math.floor(g.y);var u=g.y*annImageData.width+g.x;u*=4,l.includes(u)||(l.push(u),r[u+0]==drawColor.r&&r[u+1]==drawColor.g&&r[u+2]==drawColor.b||!o||(r[u+0]=drawColor.r,r[u+1]=drawColor.g,r[u+2]=drawColor.b,r[u+3]=128,newGrowthToolData.push([g.x,g.y])),r[u+0]==drawColor.r&&r[u+1]==drawColor.g&&r[u+2]==drawColor.b&&o&&(r[u+3]=128,newGrowthToolData.push([g.x,g.y])),r[u+0]!=drawColor.r||r[u+1]!=drawColor.g||r[u+2]!=drawColor.b||o||(r[u+0]=0,r[u+1]=0,r[u+2]=0,r[u+3]=0))}r=displayAnnotationData(r,oldGrowthToolData,newGrowthToolData,l,!0,drawColor),annImageData.data.set(r),contextAnnotation.putImageData(annImageData,0,0),svgimgann.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png"));let t={id:uuidv4(),data:newGrowthToolData};if(!annotation){let t=uuidv4(),e=0,o=cornerstoneTools.getToolState(a,"2dgrowthtool");o&&o.data.length>0&&("block"===$(".create-annotation-block")[0].style.display?(e=o.data.length-1,t=o.data[e].id,newGrowthToolData=o.data[e].data.concat(newGrowthToolData)):e=o.data.length);let n={id:t,data:newGrowthToolData};return o&&e!==o.data.length||cornerstoneTools.addToolState(a,"2dgrowthtool",n),$(".create-annotation-block").attr("tool-type","2dgrowthtool"),$(".create-annotation-block").attr("tool-data-index",e),$(".create-annotation-block").slideDown(),!0}{let e=$("#classSelected").val();if(e&&""!=e){annotation.toolData.data=newGrowthToolData;let t=cornerstoneTools.getToolState(a,"2dgrowthtool");for(var h=0;h<t.data.length;++h)if(t.data[h].id===annotation.toolData.id){t.data[h].data=newGrowthToolData;break}updateAnnotationData(a,"2dgrowthtool",annotation.toolData.id)}else showClassPickerDialog(a,t,"2dgrowthtool")}}}catch(t){console.log(t.message)}return console.log("return2 false"),!1};function _getEncodedLabel(t,e){return t[e]|t[e+1]<<8|t[e+2]<<16}function redrawSegmentation(t,e){try{var a=t.getElementsByClassName(e);if(a.length>0?((a=a[0]).setAttributeNS(null,"visibility","hidden"),a.parentElement.removeChild(a),a=null):a=null,!a){if(!(o=t.getElementsByClassName("cornerstone-canvas"))||0==o.length)return;var o,n=o[0].width,s=o[0].height,i=(o=cornerstone.getEnabledElement(t).canvas).getContext("2d").getImageData(0,0,n,s);segmentedData=drawSegmentation(i,25),(a=document.createElementNS("http://www.w3.org/2000/svg","svg")).setAttributeNS(null,"id",e),a.setAttributeNS(null,"viewBox","0 0 "+n+" "+s),a.setAttributeNS(null,"width",n),a.setAttributeNS(null,"height",s),$(a).css({position:"absolute",top:"0px",left:"0px"}),$(a).addClass("segmentationsvg"),canvasForSegmentation=document.createElement("canvas"),contextSegmentation=canvasForSegmentation.getContext("2d"),canvasForSegmentation.width=segmentedData.result.width,canvasForSegmentation.height=segmentedData.result.height,contextSegmentation.putImageData(segmentedData.imageData,0,0),(svgimg=document.createElementNS("http://www.w3.org/2000/svg","image")).setAttributeNS(null,"preserveAspectRatio","none"),svgimg.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForSegmentation.toDataURL("image/png")),a.append(svgimg),a.setAttributeNS(null,"visibility","visible"),$(t).append(a)}}catch(t){console.log(t.message)}}function setupGrowthToolLawyer(t,e,a){console.log("setupGrowthToolLawyer");try{var o=t.getElementsByClassName("cornerstone-canvas");if(!o||0==o.length)return;var n=o[0].height,s=o[0].width,i=cornerstone.getEnabledElement(t),r=i.viewport.displayedArea.tlhc.x,l=i.viewport.displayedArea.tlhc.y,c=i.viewport.displayedArea.brhc.x-r+1,d=i.viewport.displayedArea.brhc.y-l+1,g=i.viewport.scale;isNaN(g)&&(g=1),c*=g,d*=g,r=Math.floor(r+(s-c)/2),l=Math.floor(l+(n-d)/2),r+=i.viewport.translation.x*g,l+=i.viewport.translation.y*g;var u=t.getElementsByClassName("growthtool-svg");if((u=u[0]).setAttributeNS(null,"viewBox","0 0 "+c+" "+d),u.setAttributeNS(null,"width",c),u.setAttributeNS(null,"height",d),$(u).css({position:"absolute",top:l+"px",left:r+"px"}),canvasForGrowth){if(e){growthImageData=contextGrowth.getImageData(0,0,canvasForGrowth.width,canvasForGrowth.height);let t=displayGrowthData(growthImageData.data,e,[],[],hexToRGB(a),!0);growthImageData.data.set(t),contextGrowth.putImageData(growthImageData,0,0),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")),u.append(svgimggrowth)}}else canvasForGrowth=document.createElement("canvas"),contextGrowth=canvasForGrowth.getContext("2d"),canvasForGrowth.width=i.image.width,canvasForGrowth.height=i.image.height,growthImageData=contextGrowth.createImageData(canvasForGrowth.width,canvasForGrowth.height),e&&growthImageData.data.set(displayGrowthData(growthImageData.data,e,[],[],hexToRGB(a),!0)),contextGrowth.putImageData(growthImageData,0,0),(svgimggrowth=document.createElementNS("http://www.w3.org/2000/svg","image")).setAttributeNS(null,"preserveAspectRatio","none"),svgimggrowth.setAttributeNS(null,"height","100%"),svgimggrowth.setAttributeNS(null,"width","100%"),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")),u.append(svgimggrowth);u.setAttributeNS(null,"visibility","visible")}catch(t){console.log(t.message)}}var displayGrowthData=function(t,e,a,o,n,s){try{for(var i=0;i<e.length;i++){let l=e[i][0],c=e[i][1];var r=c*growthImageData.width+l;r*=4,o.includes(r)||(o.push(r),t[r+0]==n.r&&t[r+1]==n.g&&t[r+2]==n.b||!s?t[r+0]==n.r&&t[r+1]==n.g&&t[r+2]==n.b&&s&&(t[r+3]=128,a.push([l,c])):(t[r+0]=n.r,t[r+1]=n.g,t[r+2]=n.b,t[r+3]=128,a.push([l,c])),s||(t[r+0]=0,t[r+1]=0,t[r+2]=0,t[r+3]=0))}}catch(t){console.log(t)}return t};function setupAnnotationLayer(t,e,a){setupGrowthToolLawyer(t,e,a),contextAnnotation=contextGrowth,svgimgann=svgimggrowth,annImageData=growthImageData,canvasForAnnotation=canvasForGrowth}function hexToRGB(t){var e=t.match(/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i);return{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}}async function updateSegmentationColor(t,e){let a=hexToRGB(t);annData=annImageData.data;for(var o=0;o<e.length;o++){let t=e[o][0];var n=e[o][1]*annImageData.width+t;n*=4,annData[n+0]=a.r,annData[n+1]=a.g,annData[n+2]=a.b}annImageData.data.set(annData),contextAnnotation.putImageData(annImageData,0,0),svgimgann.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png"))}async function clearAnnotation(t,e){let a="",o="";"segmentationtool"===t?(o=annImageData.data,a=annImageData.width):"2dgrowthtool"===t&&(o=growthImageData.data,a=growthImageData.width);for(var n=0;n<e.data.length;n++){let t=e.data[n][0];var s=e.data[n][1]*a+t;o[(s*=4)+3]=0}"segmentationtool"===t?(annImageData.data.set(o),contextAnnotation.putImageData(annImageData,0,0),svgimgann.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png"))):"2dgrowthtool"===t&&(growthImageData.data.set(o),contextGrowth.putImageData(growthImageData,0,0),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")))}async function updateGrowthColor(t,e){let a=hexToRGB(t),o=growthImageData.data;for(var n=0;n<e.length;n++){let t=e[n][0];var s=e[n][1]*growthImageData.width+t;o[(s*=4)+0]=a.r,o[s+1]=a.g,o[s+2]=a.b}growthImageData.data.set(o),contextGrowth.putImageData(growthImageData,0,0),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png"))}function toggleSegmentation(t=!0){$("#segmentation").removeClass("active"),$("#growthtool").removeClass("active"),$(".opt-sub-list").slideUp();var e,a="segmentationsvg";(e=document.getElementById(a))&&(t?e.setAttributeNS(null,"visibility","hidden"):e.setAttributeNS(null,"visibility","visible")),a="segmentationsvg-annotation",(e=document.getElementById(a))&&(t?e.setAttributeNS(null,"visibility","hidden"):e.setAttributeNS(null,"visibility","visible")),a="growthtool-svg",(e=document.getElementById(a))&&(t?e.setAttributeNS(null,"visibility","hidden"):e.setAttributeNS(null,"visibility","visible"))}function hideSegmentation(t,e=!0){$("#segmentation").removeClass("active"),$("#growthtool").removeClass("active"),$(".opt-sub-list").slideUp();var a="";if(a="segmentationsvg",svgElement=t.getElementsByClassName(a),svgElement.length>0&&(svgElement=svgElement[0],svgElement.setAttributeNS(null,"visibility","hidden"),svgElement.parentElement.removeChild(svgElement),svgElement=null),a="segmentationsvg-annotation",svgElement=t.getElementsByClassName(a),svgElement.length>0){svgElement=svgElement[0];let t=svgElement.getElementsByTagName("image");t.length>0&&e&&contextAnnotation&&svgimgann&&canvasForAnnotation&&(svgElement.setAttributeNS(null,"visibility","hidden"),contextAnnotation.clearRect(0,0,annImageData.width,annImageData.height),annImageData=contextAnnotation.getImageData(0,0,annImageData.width,annImageData.height),t[0].setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png")))}if(a="growthtool-svg",svgElement=t.getElementsByClassName(a),svgElement.length>0){svgElement=svgElement[0],svgElement.setAttributeNS(null,"visibility","hidden");let t=svgElement.getElementsByTagName("image");t.length>0&&e&&null!=contextGrowth&&null!=svgimggrowth&&null!=canvasForGrowth&&(contextGrowth.clearRect(0,0,growthImageData.width,growthImageData.height),growthImageData=contextGrowth.getImageData(0,0,growthImageData.width,growthImageData.height),t[0].setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")))}window.segmentationEnabled=!1,window.segmentationEditable=!1}function setViewportScale(t,e,a){e.scale=a,cornerstone.setViewport(t,e)}function setupButtons(t,e){function a(){toggleSegmentation(!1)}function o(t){var e=$(".viewportWrapper").find(".viewport-active")[0],a=$("#exportContainer")[0],o=$(a).find("canvas")[0],n=o.getContext("2d");if($("#mask_img").is(":checked")&&(n.fillStyle="rgb(0, 0, 0)",n.fillRect(0,0,o.width,o.height)),!$("#hide_annts").is(":checked")){let t=$("#segmentationsvg-annotation"),e=$(t).find("image").get(0);e&&n.drawImage(e,0,0);let a=$("#growthtool-svg"),o=$(a).find("image").get(0);o&&n.drawImage(o,0,0)}setTimeout(function(){cornerstoneTools.saveAs(a,"download","image/png"),$(".exp_settings_pop,.menu_list").hide();let t=cornerstoneTools.getToolState(e,"stack").data[0],o=t.instances,n=t.currentImageIdIndex,s=o[n]?o[n]:void 0;if(s){cornerstoneTools.clearToolState(a,"freehand");for(var i=s.annotations,r=0;r<i.length;r++){var l=i[r];cornerstoneTools.addToolState(a,l.toolName,l.toolData)}}},1e3),$("#exportContainer").off("cornerstoneimagerendered")}cornerstoneTools.toolStyle.setToolWidth(1),cornerstoneTools.toolColors.setToolColor("#ffcc33"),cornerstoneTools.toolColors.setActiveColor("rgba(0,255,51,1.0)"),cornerstoneTools.toolColors.setFillColor("#0099ff"),imageViewer1=e,$("#undo").on("click touchstart",function(){forEachViewport(function(t){viewportHistory.undo(t),cornerstone.updateImage(t)})}),$("#redo").on("click touchstart",function(){forEachViewport(function(t){viewportHistory.redo(t),cornerstone.updateImage(t)})}),$("#zoomIn").on("click touchstart",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),window.zoomChangeRequest++,forEachViewport(function(t){const e=cornerstone.getViewport(t);e.scale+=.25,cornerstone.setViewport(t,e);const a={element:t};var o=jQuery.Event("cornerstonetoolsaction");o.detail=a,$(t).trigger(o)})}),$("#zoomOut").on("click touchstart",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),window.zoomChangeRequest++,forEachViewport(function(t){const e=cornerstone.getViewport(t);e.scale-=.1,cornerstone.setViewport(t,e);const a={element:t};var o=jQuery.Event("cornerstonetoolsaction");o.detail=a,$(t).trigger(o)})}),$("#probe").on("click touchstart",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),$(this).hasClass("active")||forEachViewport(function(t){cornerstoneTools.textStyle.setFont("25px Arial"),cornerstoneTools.dragProbe.activate(t,1)})}),$("#pan").on("click touchstart",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.pan.activate(t,3),cornerstoneTools.panTouchDrag.activate(t),window.panChangeRequest++})}),$("#segmentation").on("click touchstart",function(){a(),disableAllTools(),window.location.href="https://app.trainingdata.io/v1/radiology/?task=69&project=29"}),$("#subtractarea").on("click touchstart",function(){a(),disableAllTools(),window.segmentationEnabled&&$("#segmentation").click()}),$("#growthtool").on("click touchstart",function(){a(),disableAllTools(),window.location.href="https://app.trainingdata.io/v1/radiology/?task=69&project=29"}),$("#hide").on("click touchstart",function(){$(this).hasClass("active")?toggleSegmentation(!1):toggleSegmentation(!0)}),$("#delete").on("click touchstart",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.clearToolState(t,"freehand");var e=cornerstoneTools.getToolState(t,"stack");if(void 0!==e&&void 0!==e.data&&0!==e.data.length){let a=e.data[0];a.instances.length>0&&(a.instances[a.currentImageIdIndex].annotations=[],cornerstoneTools.removeToolState(t,"stack",a),cornerstoneTools.addToolState(t,"stack",a),cornerstoneTools.clearToolState(t,"2dgrowthtool"),cornerstoneTools.clearToolState(t,"segmentationtool"),function(){contextAnnotation&&svgimgann&&canvasForAnnotation&&(svgElement.setAttributeNS(null,"visibility","hidden"),contextAnnotation.clearRect(0,0,annImageData.width,annImageData.height),annImageData=contextAnnotation.getImageData(0,0,annImageData.width,annImageData.height),svgimgann.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png")));null!=contextGrowth&&null!=svgimggrowth&&null!=canvasForGrowth&&(contextGrowth.clearRect(0,0,growthImageData.width,growthImageData.height),growthImageData=contextGrowth.getImageData(0,0,growthImageData.width,growthImageData.height),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")))}())}cornerstone.updateImage(t)})}),$("#freehand").on("click",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools();cornerstoneTools.freehand.setConfiguration({mouseLocation:{handles:{start:{highlight:!0,active:!0}}},keyDown:{shift:!1,ctrl:!1,alt:!1},activePencilMode:!0,spacing:5,activeHandleRadius:3,completeHandleRadius:6,alwaysShowHandles:!1,invalidColor:"crimson",modifying:!1,movingTextBox:!1,currentHandle:0,currentTool:-1,isFreehand:!0,showTextbox:!1}),forEachViewport(function(t){cornerstoneTools.freehand.activate(t,1)})}),$("#rectangle").on("click",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.rectangleRoi.activate(t,1)})}),$("#brightness").on("click touchstart",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.wwwc.activate(t,1),cornerstoneTools.wwwcTouchDrag.activate(t)}),forEachViewport(function(t){let e=cornerstone.getViewport(t),a=e.voi.windowWidth;$(".br-range").text(a),$("#brightnessRange").slider({value:a,max:3e3,min:-3e3,slide:function(a,o){$(".br-range").text(o.value);var n=$("#"+a.target.id).find(".ui-slider-handle").css("left");$(".br-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowWidth=parseFloat(o.value),setBrightness(parseFloat(o.value)),cornerstone.setViewport(t,e)},change:function(a,o){$(".br-range").text(o.value);var n=$("#"+a.target.id).find(".ui-slider-handle").css("left");$(".br-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowWidth=parseFloat(o.value),setBrightness(parseFloat(o.value)),cornerstone.setViewport(t,e)},stop:function(e,a){const o={element:t};(e=jQuery.Event("cornerstonetoolsaction")).detail=o,$(t).trigger(e)}})})}),$("#contrast").on("click touchstart",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.wwwc.activate(t,1),cornerstoneTools.wwwcTouchDrag.activate(t)}),forEachViewport(function(t){let e=cornerstone.getViewport(t),a=e.voi.windowCenter;$(".cr-range").text(a),$("#contrastRange").slider({value:a,max:500,min:-500,slide:function(a,o){$(".cr-range").text(o.value);var n=$("#"+a.target.id).find(".ui-slider-handle").css("left");$(".cr-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowCenter=parseFloat(o.value),setContrast(parseFloat(o.value)),cornerstone.setViewport(t,e)},change:function(a,o){$(".cr-range").text(o.value);var n=$("#"+a.target.id).find(".ui-slider-handle").css("left");$(".cr-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowCenter=parseFloat(o.value),setContrast(parseFloat(o.value)),cornerstone.setViewport(t,e)},stop:function(e,a){const o={element:t};(e=jQuery.Event("cornerstonetoolsaction")).detail=o,$(t).trigger(e)}})})}),$("#wlwc").on("click touchstart",function(){if(a(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.wwwc.activate(t,1),cornerstoneTools.wwwcTouchDrag.activate(t);let e=cornerstone.getViewport(t),a=e.voi.windowWidth,o=e.voi.windowCenter;$(".ww-range").text(a),$(".wc-range").text(o),$("#windowWidthRange").slider({value:a,max:3e3,min:-3e3,slide:function(a,o){$(".ww-range").text(o.value);var n=$("#"+a.target.id).find(".ui-slider-handle").css("left");$(".ww-before").css("width",n),e=cornerstone.getViewport(t),(e=cornerstone.getViewport(t)).voi.windowWidth=parseFloat(o.value),setBrightness(parseFloat(o.value)),cornerstone.setViewport(t,e)},change:function(a,o){$(".ww-range").text(o.value);var n=$("#"+a.target.id).find(".ui-slider-handle").css("left");$(".ww-before").css("width",n),e=cornerstone.getViewport(t),(e=cornerstone.getViewport(t)).voi.windowWidth=parseFloat(o.value),setBrightness(parseFloat(o.value)),cornerstone.setViewport(t,e)},stop:function(e,a){const o={element:t};(e=jQuery.Event("cornerstonetoolsaction")).detail=o,$(t).trigger(e)}}),$("#windowCenterRange").slider({value:o,max:500,min:-500,slide:function(a,o){$(".wc-range").text(o.value);var n=$("#"+a.target.id).find(".ui-slider-handle").css("left");$(".wc-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowCenter=parseFloat(o.value),setContrast(parseFloat(o.value)),cornerstone.setViewport(t,e)},change:function(a,o){$(".wc-range").text(o.value);var n=$("#"+a.target.id).find(".ui-slider-handle").css("left");$(".wc-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowCenter=parseFloat(o.value),setContrast(parseFloat(o.value)),cornerstone.setViewport(t,e)},stop:function(e,a){const o={element:t};(e=jQuery.Event("cornerstonetoolsaction")).detail=o,$(t).trigger(e)}})})}),$("#invert").on("click touchstart",function(){if(a(),$(".data-list li").removeClass("active"),$(".opt-sub-list").slideUp(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){var e=cornerstone.getViewport(t);!0===e.invert?e.invert=!1:e.invert=!0,cornerstone.setViewport(t,e);const a={element:t};var o=jQuery.Event("cornerstonetoolsaction");o.detail=a,$(t).trigger(o)})}),$("#download").on("click touchstart",function(){a(),$(".exp_settings_pop").show()}),$(".export_btn").on("click touchstart",function(){$(".menu_list ul").show(),disableAllTools();var t=$("#exportContainer")[0];cornerstone.enable(t);var e=$(t).find("canvas")[0],a=$(".viewportWrapper").find(".viewport-active")[0],n=cornerstone.getEnabledElement(a);const s=Object.assign({},n.viewport);delete s.scale,s.translation={x:0,y:0};let i=cornerstoneTools.getToolState(a,"stack").data[0],r=i.instances,l=i.currentImageIdIndex,c=r[l]?r[l]:void 0;$("#exportContainer").on("cornerstoneimagerendered",o),cornerstone.loadImage(n.image.imageId).then(a=>{cornerstone.displayImage(t,a),cornerstone.setViewport(t,s),cornerstone.resize(t,!0);const o=a.width,n=a.height;if($(t).width(o),$(t).height(n),e.width=o,e.style.width=`${o}px`,e.height=n,e.style.height=`${n}px`,cornerstone.fitToWindow(t),cornerstoneTools.clearToolState(t,"freehand"),c){$("#export_annotation_class").val();for(var i=c.annotations,r=0;r<i.length;r++)i[r]}cornerstone.updateImage(t),$("#hide_annts").is(":checked")?(cornerstoneTools.freehand.disable(t),cornerstoneTools.rectangleRoi.disable(t)):(cornerstoneTools.freehand.enable(t),cornerstoneTools.rectangleRoi.enable(t))})})}function disableAllTools(){forEachViewport(function(t){console.log("disableAllTools"),cornerstoneTools.wwwc.disable(t),cornerstoneTools.pan.deactivate(t,2),cornerstoneTools.zoom.deactivate(t,4),cornerstoneTools.dragProbe.deactivate(t,1),cornerstoneTools.freehand.deactivate(t,1),cornerstoneTools.angle.deactivate(t,1),cornerstoneTools.ellipticalRoi.deactivate(t,1),cornerstoneTools.rectangleRoi.deactivate(t,1),cornerstoneTools.stackScroll.deactivate(t,1),cornerstoneTools.wwwcTouchDrag.deactivate(t),cornerstoneTools.zoomTouchDrag.deactivate(t),cornerstoneTools.panTouchDrag.deactivate(t),cornerstoneTools.stackScrollTouchDrag.deactivate(t),cornerstoneTools.rectangleRoi.deactivate(t,1)})}function forEachViewport(t){var e=$(".viewport");$.each(e,function(e,a){var o=a;try{t(o)}catch(t){}})}ImageViewer=function(t,e){var a=this;a.root=t,a.stacks=[],a.viewports=[],a.layout="1x1",a.viewportModel=e,a.setLayout=function(t){a.layout=t;var e=a.getRowsCols(),o=e[0],n=e[1],s=o*n,i=100/n,r=100/o;a.root.find(".imageViewer").html("");var l=0;for(a.viewports=[];l<s;){var c=a.viewportModel.clone().css({width:i+"%",height:r+"%"}).appendTo(a.root.find(".imageViewer"));c.find(".viewport").data("index",l).data("waiting",!0),a.viewports.push(c),l++}},a.getRowsCols=function(){var t=a.layout.split(/x/);return[parseInt(t[0]),parseInt(t[1])]},a.isSingle=function(){return"1x1"==a.layout},a.getElement=function(t){return a.viewports[t].find(".viewport")[0]},a.forEachElement=function(t){a.viewports.forEach(function(e,o){t.call(a,e.find(".viewport")[0],e,o)})}};const loadTemplate=async t=>{var e=$("</div>"),a=await axios.get(t);if(200===a.status){var o=$.parseHTML(a.data);$.each($(o),function(t,a){if("DIV"===a.nodeName)return e=$(a),!1})}return e};function setupViewportOverlays(t,e){var a=$(t).parent(),o=$(a).find(".overlay"),n=$(o[0]).find("div"),s=$(o[1]).find("div"),i=$(o[2]).find("div"),r=$(o[3]).find("div");$(n[0]).text(e.patientName),$(n[1]).text(e.patientId),$(s[1]).text(e.studyDate),$(t).on("cornerstonenewimage",function(e,a){var o=cornerstoneTools.getToolState(t,"playClip");void 0!==o&&o.data.length>0&&void 0!==o.data[0].intervalId&&void 0!==a.frameRate?$(i[0]).text("FPS: "+Math.round(a.frameRate)):$(i[0]).text().length>0&&$(i[0]).text("");var n=cornerstoneTools.getToolState(t,"stack");if(void 0!==n&&void 0!==n.data&&0!==n.data.length){var r=n.data[0];$(i[2]).text("Image # "+(r.currentImageIdIndex+1)+"/"+r.imageIds.length),$(s[2]).text(function(t){let e=t.split("/");if(lastSegment=e[e.length-1],lastSegment=lastSegment.substring(0,lastSegment.lastIndexOf(".")),lastSegment.length>15){let t=lastSegment.substring(0,4)+"..."+lastSegment.substring(lastSegment.length-1-4,lastSegment.length);lastSegment=t}return lastSegment}(r.imageIds[r.currentImageIdIndex])),$(s[0]).text(r.seriesDescription),hideSegmentation(t,!0),handleAnnotationOnImageIndexChange(t,r)}}),$(t).on("cornerstoneimagerendered",function(e){var a=e.detail;if($(r[0]).text("Zoom:"+a.viewport.scale.toFixed(2)),$(r[1]).text("WW/WL:"+Math.round(a.viewport.voi.windowWidth)+"/"+Math.round(a.viewport.voi.windowCenter)),void 0===a.renderTimeInMs||isNaN(a.renderTimeInMs)||$(i[1]).text("Render Time:"+a.renderTimeInMs.toFixed(2)+" ms"),window.zoomChangeRequest>0){window.zoomChangeRequest=0,hideSegmentation(t,!0);var o=cornerstoneTools.getToolState(t,"stack");if(void 0===o||void 0===o.data||0===o.data.length)return;var n=o.data[0];handleAnnotationOnImageIndexChange(t,n)}}),$(t).on("cornerstonetoolsmousedrag",function(e){if(e.detail&&$("#pan").hasClass("active")){window.panChangeRequest=0,hideSegmentation(t,!0);var a=cornerstoneTools.getToolState(t,"stack");if(void 0===a||void 0===a.data||0===a.data.length)return;var o=a.data[0];handleAnnotationOnImageIndexChange(t,o)}})}var baseURL=BASE_URL,taskId=0,projectId=0;function resizeMain(){var t=$(window).height();$(".ai-container").height(t-80)}window.onload=(async()=>{$(".data-list li").addClass("disabled"),cornerstoneWADOImageLoader.external.cornerstone=cornerstone,cornerstoneWebImageLoader.external.cornerstone=cornerstone;var t;cornerstoneWADOImageLoader.webWorkerManager.initialize({webWorkerPath:"./../assets/vendor/cornerstone/cornerstoneWADOImageLoaderWebWorker.min.js",taskConfiguration:{decodeTask:{codecsPath:"cornerstoneWADOImageLoaderCodecs.min.js"}}}),t=await loadTemplate("templates/viewport.html"),taskId=GetQueryParameterByName("task"),projectId=GetQueryParameterByName("project"),await loadStudy($(".ai-container"),t,taskId,projectId)}),$(window).resize(function(){resizeMain()}),resizeMain(),document.body.addEventListener("touchmove",function(t){t.preventDefault()}),$(document).on("click touchstart",".viewport",function(){$(".viewport").removeClass("viewport-active"),$(this).addClass("viewport-active")}),$(function(){$("#mycolor").colorpicker({history:!1})}),$(document).on("click",".aid-close",function(){var t=$(this).parents(".ai-dialog").attr("data-close");void 0!==t&&$('[data-source="'+t+'"').removeClass("active"),$(this).parents(".opt-sub-list").slideUp()}),$(document).on("click",".data-edit li",function(){$(".data-edit li").removeClass("active"),0==$(this).find(".opt-sub-list").length&&$(".opt-sub-list").slideUp(),$(this).addClass("active")}),parent.find(".opt-sub-list"),$(document).on("click",".series",function(){if($(this).hasClass("active"))return $(this).removeClass("active"),$(".ai-main-data").find(".left-data").addClass("closed"),!1;$(".ai-main-data").find(".left-data").removeClass("closed"),$(this).addClass("active")}),$(document).on("click",".opt-group",function(){$(".data-edit li").removeClass("active");var t=$(this).parents("li");return t.hasClass("active")?(console.log("is active"),t.find(".opt-sub-list").slideUp(),t.removeClass("active"),!1):t.find(".opt-sub-list").is(":visible")?(t.find(".opt-sub-list").slideUp(),t.removeClass("active"),!1):($(".opt-group").parents("li").removeClass("active"),$(".opt-sub-list").slideUp(),t.find(".opt-sub-list").slideDown(),void t.addClass("active"))}),$(document).on("click",".selected-color",function(){$(".annotation-color-picker").addClass("show")}),$(document).on("click",".go-back",function(){$(".annotation-color-picker").removeClass("show")}),$("#mycolor").on("change.color",function(t,e){$("#selectedColor").attr("value",e),$(".se-cl").css("background",e)}),$(document).on("click",".reset-range",function(){switch(console.log($(this).attr("data-reset")),$(this).parents(".ai-dialog").addClass("ai-transition"),$(this).attr("data-reset")){case"br":$("#brightnessRange").slider({value:0}),$(".br-before").css("width",0),$(".br-range").text("0");break;case"cr":$("#contrastRange").slider({value:0}),$(".cr-before").css("width",0),$(".cr-range").text("0");break;case"growthrange":$("#growthRange").slider({value:0}),$(".growthrange-before").css("width",0),$(".growthrange-range").text("-0 to 0");break;case"ww-wc":$("#windowWidthRange, #windowCenterRange").slider({value:0}),$(".wc-before, .ww-before").css("width",0),$(".wc-range, .ww-range").text("0")}setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-abdominal-soft-tissue",function(){console.log($(this).attr("preset-abdominal-soft-tissue")),$("#windowWidthRange").slider({value:400}),$("#windowCenterRange").slider({value:40}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-bone",function(){$("#windowWidthRange").slider({value:3e3}),$("#windowCenterRange").slider({value:550}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-brain",function(){$("#windowWidthRange").slider({value:80}),$("#windowCenterRange").slider({value:35}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-brain-narrow",function(){$("#windowWidthRange").slider({value:40}),$("#windowCenterRange").slider({value:30}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-liver",function(){$("#windowWidthRange").slider({value:200}),$("#windowCenterRange").slider({value:50}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-lung",function(){$("#windowWidthRange").slider({value:1800}),$("#windowCenterRange").slider({value:-600}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-subdural-brain",function(){$("#windowWidthRange").slider({value:200}),$("#windowCenterRange").slider({value:75}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".grouped .data-src-img-block",function(){$(".grouped .data-src-img-block").removeClass("active"),$(this).addClass("active")}),$(document).on("click",".menu-icon",function(){$(".menu_list ul").css({"z-index":500}),$(".menu_list").toggle()}),$(document).on("click",".exp_annts",function(){$(this).parents(".menu_list ul").hide(),$(".exp_settings_pop").show()}),$(document).on("click",".exp_settings_pop .aid-close",function(){$(".exp_settings_pop,.menu_list").hide(),$(".menu_list ul").show()});