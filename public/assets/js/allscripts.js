var segmentationEnabled=!1,singleLayout=!0,classes=[],zoomChangeRequest=0,panChangeRequest=0,showLoader=!1,growthRangeDefault=20,growthRange=growthRangeDefault,growthRange3dDefault=10,growthRange3d=growthRange3dDefault,viewportHistory=function(){var t={},e=-1;function o(o){if(o.detail){var a=cornerstone.getEnabledElement(o.detail.element);if(a.image){var n=a.image.imageId,s=cornerstone.getViewport(o.detail.element),i={viewport:$.extend(!0,{},s)};t.hasOwnProperty(n)||(t[n]=[]),e+=1,t[n].splice(e,0,i)}}}function a(o,a){var n=cornerstone.getEnabledElement(o).image.imageId,s=t[n][a];cornerstone.setViewport(o,s.viewport),e=a,console.log(t)}return{enable:function(t){$(t).off("cornerstonetoolsaction",o),$(t).on("cornerstonetoolsaction",o);var e={element:t},a=jQuery.Event("cornerstonetoolsaction");a.detail=e,$(t).trigger(a)},disable:function(t){$(t).off("cornerstonetoolsaction",o)},undo:function(t,o){void 0===o&&(o=1);var n=e-o;n<0||(console.log("Undoing "+o+" step(s) to step "+n),a(t,n))},redo:function(o,n){void 0===n&&(n=1);var s=cornerstone.getEnabledElement(o).image.imageId,i=e+n;i>t[s].length||(console.log("Redoing "+n+" step(s) to step "+i),a(o,i))},add:o,reset:function(e){console.log("Clearing state stack"),t={}}}}();String.prototype.format=function(){for(k in a=this,arguments)a=a.replace("{"+k+"}",arguments[k]);return a};const GetQueryParameterByName=function(t,e){e||(e=window.location.href),t=t.replace(/[\[\]]/g,"\\$&");var o=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return o?o[2]?decodeURIComponent(o[2].replace(/\+/g," ")):"":null},ConvertToDate=function(t){let e=Date.now();try{e=new Date(1e3*t)}catch{}return e},uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},hexa2rgba=function(t,e){return"rgba("+parseInt(t.slice(-6,-4),16)+","+parseInt(t.slice(-4,-2),16)+","+parseInt(t.slice(-2),16)+","+e+")"},SessionExists=function(){return void 0!==Cookies.get("rtai_session_key")},GetSessionKey=function(){let t=Cookies.get("rtai_session_key");return void 0!==t?t:""},CreateSessionCookie=function(t,e,o){Cookies.set("rtai_session_key",t,{secure:o,expires:ConvertToDate(e),path:""})},GetCsrfCookie=function(){let t=Cookies.get("csrftoken");return void 0!==t?t:""},api=axios.create({baseURL:SERVICE_URL,timeout:2e4,headers:{"X-CSRFToken":GetCsrfCookie()},withCredentials:!0});axios.defaults.headers.post["Content-Type"]="application/json",axios.defaults.headers.put["Content-Type"]="application/json";const loadProjects=async(t,e)=>{let o="/project".format(),a={};try{const t=await api.get(o);a={status:t.status,statusText:t.statusText,data:t.data}}catch(t){handle401(t.response)}return a},postAnnotation=async t=>{let e={};try{const o=await api.post("/cornerstoneannotation",t);e={status:o.status,statusText:o.statusText,data:o.data}}catch(t){handle401(t.response)}return e},updateAnnotation=async(t,e)=>{let o="/cornerstoneannotation/"+t,a={};try{const t=await api.put(o,e);a={status:t.status,statusText:t.statusText,data:t.data}}catch(t){handle401(t.response)}return a},deleteAnnotation=async t=>{let e="/cornerstoneannotation/"+t,o={};try{const t=await api.delete(e);o={status:t.status,statusText:t.statusText,data:t.data}}catch(t){handle401(t.response)}return o},handle401=function(t){if(401===t.status||403===t.status){let t=BASE_URL+"?task="+taskId+"&project="+projectId;window.location.href=SERVICE_URL+"/auth/login?callback="+encodeURIComponent(t)}},updateStudyConfig=async t=>{let e="/task/{0}/job/{1}".format(taskId,projectId),o={};try{const a=await api.put(e,t);o={status:a.status,statusText:a.statusText,data:a.data}}catch(t){handle401(t.response)}return o};let enabledElement;function setupAnnotationHandler(t){enabledElement=t,$(t).on("cornerstonetoolsenddrawing",function(t){let e=t.detail.type,o=t.detail.currentTool,a=t.detail.modifying;enabledElement=t.detail.element,a?updateAnnotationData(enabledElement,e,t.detail.id):($(".create-annotation-block").attr("tool-data-index",o),$(".create-annotation-block").attr("tool-type",e),$(".create-annotation-block").attr("data-annotation-tool",t.id),$(".create-annotation-block").slideDown())})}function handleAnnotationOnImageIndexChange(t,e){let o=e.instances,a=e.currentImageIdIndex,n=o[a]?o[a]:void 0,s=!0;if(n){var i=n.annotations;if(n.annotationLoaded||(s=!1,i.length>0&&(e.instances[e.currentImageIdIndex].annotationLoaded=!0,cornerstoneTools.removeToolState(t,"stack",e),cornerstoneTools.addToolState(t,"stack",e))),$(".grid-select").find("div.active").length<=1)if(i.length>0){$(".ants-list-group").empty();for(var r=0;r<i.length;r++){let o=i[r];if(o.toolData){if(o.toolData.color=o.selectedColor,o.toolData.fillStyle=hexa2rgba(o.selectedColor,.3),!s)switch(o.toolName){case"rectangleRoi":cornerstoneTools.addToolState(t,"rectangleRoi",o.toolData);break;case"freehand":cornerstoneTools.addToolState(t,"freehand",o.toolData);break;case"2dgrowthtool":cornerstoneTools.addToolState(t,"2dgrowthtool",o.toolData);break;case"segmentationtool":cornerstoneTools.addToolState(t,"segmentationtool",o.toolData)}o.selectedColor=o.selectedColor.slice(0,7);var l='<li class="ants-list-item" data-annotation-type="'+o.toolName+'" data-annotation-id="'+o.id+'"  ><div class="ant-header" style="background: '+o.selectedColor+'"><div class="ant-title"><p>Class: <strong>'+o.annotationClass+'</strong></p></div><div class="ant-delete" data-annotation-tool="'+o.toolData.id+'" tool-data-index="'+o.toolDataIndex+'"><img src="assets/images/a-delete.svg" alt="Delete" /></div></div><div class="ant-info" style="background: '+hexa2rgba(o.selectedColor,.8)+'"><p><strong>'+o.annotationName+"</strong></p><p>Notes:<br />"+o.annotationDescription+"</p></div></li>";$(".ants-list-group").prepend(l),"2dgrowthtool"===o.toolName?setupGrowthToolLawyer(t,o.toolData.data,o.selectedColor):"segmentationtool"===o.toolName&&setupAnnotationLayer(t,o.toolData.data,o.selectedColor),"2dgrowthtool"!==o.toolName&&"segmentationtool"!==o.toolName||replicateOnAllImages(t,e,o,a)}}$("#annotations_list").removeClass("hide")}else $(".ants-list-group").empty(),$("#annotations_list").addClass("hide");else{$(".ants-list-group").empty(),$("#annotations_list").addClass("hide");var d=$(t).parent(".viewportWrapper").find(".small-annotation-list");if($(d).find("ul").empty(),i.length>0){var c=i.length<2?i.length:2;for(r=0;r<c;r++){let e=i[r];l='<li data-annotation-type="'+e.toolName+'" data-annotation-id="'+e.id+'" style="background: '+e.selectedColor+'"><p>'+e.annotationName+'</p><div class="delete-annotation" data-annotation-tool="'+e.toolData.id+'" tool-data-index="'+e.toolDataIndex+'"><img src="assets/images/small-delete.svg" alt="Delete"></div></li>';$(d).find("ul").prepend(l),"2dgrowthtool"===e.toolName?setupGrowthToolLawyer(t,e.toolData.data,e.selectedColor):"segmentationtool"===e.toolName&&setupAnnotationLayer(t,e.toolData.data,e.selectedColor)}if(i.length>2){var g='<li class = "more-annotations"><p> +'+(i.length-2)+" more </p></li>";$(d).find("ul").append(g)}var u=$(t).parent(".viewportWrapper").find(".overlay"),h=$(u[2]).find("div"),w=$(u[3]).find("div");$(h).parent().css({bottom:"40px"}),$(w).parent().css({bottom:"40px"}),$(d).show()}else{u=$(t).parent(".viewportWrapper").find(".overlay"),h=$(u[2]).find("div"),w=$(u[3]).find("div");$(h).parent().css({bottom:"0px"}),$(w).parent().css({bottom:"0px"}),$(d).find("ul").empty(),$(d).hide()}}}}function replicateOnAllImages(t,e,o,a){for(var n=0;n<e.instances.length;++n)if(n!=a){for(var s=!1,i=0;i<e.instances[n].annotations.length;++i)if(e.instances[n].annotations[i].annotationClass===o.annotationClass){s=!0;break}s||(newAnnotation=Object.assign({},o),newAnnotation.toolData={id:uuidv4(),data:[]},newAnnotation.id=uuidv4(),e.instances[n].annotations.push(newAnnotation),e.instances[n].annotationLoaded=!1)}}function resetAnnotationFields(){$("#annotation_name").val(""),$("#annotation_description").val("")}function validateAnnotationFields(){var t=!0;return $("#classSelected").val()?$(".ai-form-annotation").removeClass("form-required"):($(".ai-form-annotation").addClass("form-required"),t=!1),$("#annotation_name")[0].checkValidity()?$("#annotation_name").removeClass("form-required"):($("#annotation_name").addClass("form-required"),t=!1),$("#annotation_description")[0].checkValidity()?$("#annotation_description").removeClass("form-required"):($("#annotation_description").addClass("form-required"),t=!1),$("#selectedColor").val()?$(".selected-color").removeClass("form-required"):($(".selected-color").addClass("form-required"),t=!1),t}function addAnnotationToView(t,e){if($(".grid-select").find("div.active").length<=1){t.selectedColor=t.selectedColor.slice(0,7);var o='<li class="ants-list-item" data-annotation-type="'+t.toolName+'" data-annotation-id="'+t.id+'"  ><div class="ant-header" style="background: '+t.selectedColor+'"><div class="ant-title"><p>Class: <strong>'+t.annotationClass+'</strong></p></div><div class="ant-delete" data-annotation-tool="'+t.toolData.id+'" tool-data-index="'+t.toolDataIndex+'"><img src="assets/images/a-delete.svg" alt="Delete" /></div></div><div class="ant-info" style="background: '+hexa2rgba(t.selectedColor,.8)+'"><p><strong>'+t.annotationName+"</strong></p><p>Notes:<br />"+t.annotationDescription+"</p></div></li>";$(".ants-list-group").prepend(o),$("#annotations_list").removeClass("hide").slideDown()}else{$(".ants-list-group").empty(),$("#annotations_list").addClass("hide");var a=$(enabledElement).parent(".viewportWrapper").find(".small-annotation-list");o='<li style="background: '+t.selectedColor+'"><p>'+t.annotationName+'</p><div class="delete-annotation" tool-data-index="'+t.toolDataIndex+'"><img src="assets/images/small-delete.svg" alt="Delete"></div></li>';$(a).find("ul").prepend(o);var n=$(enabledElement).parent(".viewportWrapper").find(".overlay"),s=$(n[2]).find("div"),i=$(n[3]).find("div");$(s).parent().css({bottom:"40px"}),$(i).parent().css({bottom:"40px"}),$(a).show()}$(".create-annotation-block").slideUp()}function updateAnnotationData(t,e,o){let a=cornerstoneTools.getToolState(t,"stack").data[0],n=a.instances,s=a.currentImageIdIndex,i=n[s]?n[s]:void 0;if(i){let n=i.cornerstoneAnnotationId;var r=i.annotations;if(r.length>0){var l=cornerstoneTools.getToolState(t,[e]);if(l.data&&l.data.length>0){let e=jQuery.grep(l.data,function(t,e){return t.id===o});for(var d=!1,c=r.length-1;c>=0;c--)r[c].toolData?r[c].toolData.id===o&&(a.instances[s].annotations[c].toolData=e[0],d=!0):(r.splice(c,1),d=!0);if(d){let e={seriesId:a.seriesId,instanceId:a.instances[s].instanceId,jsonstring:JSON.stringify(a.instances[s].annotations)};const o=JSON.stringify(e);if(n)updateAnnotation(n,o);else{n=postAnnotation(o).id,a.instances[s].cornerstoneAnnotationId=n}cornerstoneTools.removeToolState(t,"stack",a),cornerstoneTools.addToolState(t,"stack",a)}}}}}function updateAnnotationData2(t,e,o,a,n){let s=cornerstoneTools.getToolState(t,"stack").data[0],i=s.instances,r=i[a]?i[a]:void 0;if(r){let i=r.cornerstoneAnnotationId;var l=r.annotations;if(l.length>0){var d=cornerstoneTools.getToolState(t,[e]);if(d.data&&d.data.length>0){let e=jQuery.grep(d.data,function(t,e){return t.id===o});for(var c=!1,g=l.length-1;g>=0;g--)l[g].toolData?l[g].toolData.id===o&&(s.instances[a].annotations[g].toolData=e[0],c=!0):(l.splice(g,1),c=!0);if(c){let e={seriesId:s.seriesId,instanceId:s.instances[a].instanceId,jsonstring:JSON.stringify(s.instances[a].annotations)};const o=JSON.stringify(e);if(n)if(i)updateAnnotation(i,o);else{i=postAnnotation(o).id,s.instances[a].cornerstoneAnnotationId=i}cornerstoneTools.removeToolState(t,"stack",s),cornerstoneTools.addToolState(t,"stack",s)}}}}}function deleteAnnotation1(t,e,o,a){let n=cornerstoneTools.getToolState(enabledElement,t);if(n&&n.data&&n.data.length>0){let i=jQuery.grep(n.data,function(t,o){return t.id===e});if(i&&i.length>0){cornerstoneTools.removeToolState(enabledElement,t,i[0]);let n=cornerstoneTools.getToolState(enabledElement,"stack").data[0],r=n.instances,l=n.currentImageIdIndex,d=r[o]?r[o]:void 0;if(d){let i=jQuery.grep(d.annotations,function(t,o){return t.toolData.id===e});var s=!1;if(i){for(let t=0;t<d.annotations.length;t++)i[0].id!==n.instances[o].annotations[t].id?d.annotations[t].toolData||(d.annotations.splice(t,1),s=!0):(n.instances[o].annotations[t].toolData.data.length>0&&(s=!0),n.instances[o].annotations.splice(t,1));if(cornerstoneTools.removeToolState(enabledElement,"stack",n),cornerstoneTools.addToolState(enabledElement,"stack",n),l!==o||"2dgrowthtool"!==t&&"segmentationtool"!==t||clearAnnotation(t,i[0].toolData),a&&s){let t={seriesId:n.seriesId,instanceId:n.instances[o].instanceId,jsonstring:JSON.stringify(n.instances[o].annotations)};const e=JSON.stringify(t);updateAnnotation(n.instances[o].cornerstoneAnnotationId,e)}}}}}}$("#annotation_add").on("click",function(t){var e=$(".create-annotation-block").attr("tool-data-index"),o=$(".create-annotation-block").attr("tool-type");if(validateAnnotationFields()){let t=$("#classSelected").val(),s=$("#annotation_name").val(),i=$("#annotation_description").val(),r=$("#selectedColor").val(),l=cornerstoneTools.getToolState(enabledElement,"stack").data[0],d=l.currentImageIdIndex,c=l.instances[d].cornerstoneAnnotationId;var a=cornerstoneTools.getToolState(enabledElement,[o]);if("2dgrowthtool"==o?updateGrowthColor(r,a.data[e].data):"segmentationtool"==o&&updateSegmentationColor(r,a.data[e].data),a.data&&a.data.length>0){let g={id:uuidv4(),annotationClass:t,annotationName:s,annotationDescription:i,selectedColor:r,toolName:o,toolData:a.data[e],toolDataIndex:e,annotatedOn:Date.now()};g.toolData.color=g.selectedColor,g.toolData.fillStyle=hexa2rgba(g.selectedColor,.3),addAnnotationToView(g,e),l.instances[d].annotations.push(g),"2dgrowthtool"!==o&&"segmentationtool"!==o||replicateOnAllImages(enabledElement,l,g,d);for(var n=l.instances[d].annotations.length-1;n>=0;n--)l.instances[d].annotations[n].toolData||l.instances[d].annotations.splice(n,1);let u={seriesId:l.seriesId,instanceId:l.instances[d].instanceId,jsonstring:JSON.stringify(l.instances[d].annotations)};const h=JSON.stringify(u);if(c)updateAnnotation(c,h);else{c=postAnnotation(h).id,l.instances[d].cornerstoneAnnotationId=c}cornerstoneTools.removeToolState(enabledElement,"stack",l),cornerstoneTools.addToolState(enabledElement,"stack",l),resetAnnotationFields()}}cornerstone.updateImage(enabledElement)}),$(document).on("click touchstart",".cancel-annotation",function(){var t=$(".create-annotation-block").attr("tool-data-index"),e=$(".create-annotation-block").attr("tool-type");let o=cornerstoneTools.getToolState(enabledElement,e).data[t];cornerstoneTools.removeToolState(enabledElement,e,o),cornerstone.updateImage(enabledElement),"2dgrowthtool"!==e&&"segmentationtool"!==e||clearAnnotation(e,o),$(this).parents(".create-annotation-block").slideUp(),resetAnnotationFields()}),$(document).on("click touchstart",".ant-delete",function(){var t=$(this).parents("li").attr("data-annotation-type"),e=$(this).attr("data-annotation-tool");$(this).parents("li").attr("data-annotation-id");let o=cornerstoneTools.getToolState(enabledElement,"stack").data[0];o.instances;deleteAnnotation1(t,e,o.currentImageIdIndex,!0),cornerstone.updateImage(enabledElement),$(this).parents(".ants-list-item").remove(),0==$(".ants-list-group li").length&&$("#annotations_list").addClass("hide")}),$(document).on("click touchstart",".delete-annotation",function(){var t=$(this).parents("li").attr("data-annotation-id"),e=$(this).parents("li").attr("data-annotation-type"),o=$(this).parents(".viewportWrapper"),a=$(this).parents(".viewportWrapper").find(".viewport")[0],n=cornerstone.getEnabledElement(a);let s=$(this).attr("data-annotation-tool"),i=cornerstoneTools.getToolState(n.element,e);if(i&&i.data&&i.data.length>0){let a=jQuery.grep(i.data,function(t,e){return t.id===s});if(a&&a.length>0){cornerstoneTools.removeToolState(n.element,e,a[0]);let s=cornerstoneTools.getToolState(n.element,"stack").data[0],i=s.instances,c=s.currentImageIdIndex,g=i[c]?i[c]:void 0;if(g){let o=jQuery.grep(g.annotations,function(e,o){return e.id===t});if(o){for(let t=0;t<g.annotations.length;t++)o[0].id===s.instances[c].annotations[t].id&&s.instances[c].annotations.splice(t,1);cornerstoneTools.removeToolState(n.element,"stack",s),cornerstoneTools.addToolState(n.element,"stack",s),"2dgrowthtool"!==e&&"segmentationtool"!==e||clearAnnotation(e,o[0].toolData)}}if(cornerstone.updateImage(n.element),$(this).parents("li").remove(),0==$(o).find(".sm-anno-ul li").length){var r=$(o).find(".overlay"),l=$(r[2]).find("div"),d=$(r[3]).find("div");$(l).parent().css({bottom:"0px"}),$(d).parent().css({bottom:"0px"}),$(o).find(".small-annotation-list").hide()}}}}),$(document).on("click touchstart",".ant-edit",function(){window.segmentationEditable?window.segmentationEditable=!1:window.segmentationEditable=!0});var segmentedData,svgimg,canvasForSegmentation,contextSegmentation,imageViewer1,canvasForAnnotation,contextAnnotation,svgimgann,annImageData,canvasForGrowth,contextGrowth,svgimggrowth,growthImageData,growthRegion,growthRegionId,mouseDown=!1,lastMousePosition={},lastMove="";function setupViewport(t,e,o){function a(t){let e=!0;return!function(t){var e=0,o=0;if(void 0!==lastMousePosition.x&&(e=lastMousePosition.x-t.clientX,o=lastMousePosition.y-t.clientY,Math.abs(e)>=Math.abs(o)&&e>0))return!0;return!1}(t)?!function(t){var e=0,o=0;if(void 0!==lastMousePosition.x&&(e=lastMousePosition.x-t.clientX,o=lastMousePosition.y-t.clientY,Math.abs(e)>=Math.abs(o)&&e<0))return!0;return!1}(t)?"left"==lastMove?e=!1:"right"==lastMove&&(e=!0):(e=!0,lastMove="right"):(e=!1,lastMove="left"),e}cornerstone.displayImage(t,o),void 0!==e.frameRate&&cornerstone.playClip(t,e.frameRate),cornerstoneTools.mouseInput.enable(t),cornerstoneTools.mouseWheelInput.enable(t),cornerstoneTools.touchInput.enable(t),cornerstoneTools.addStackStateManager(t,["playClip"]),cornerstoneTools.addToolState(t,"stack",e),cornerstoneTools.stackScrollWheel.activate(t),cornerstoneTools.stackPrefetch.enable(t),$(t).on("click",function(e){var o=t.getElementsByClassName("cornerstone-canvas");o.length>0&&window.segmentationEnabled&&(null==lastMousePosition||0==lastMousePosition.updated)&&updateIfActive(e,o[0],t,window.segmentationEnabled),lastMousePosition={x:e.clientX,y:e.clientY,updated:!1}}),$(t).on("mousedown",function(e){window.showLoader&&(document.getElementById("loader").className="loader1"),mouseDown=!0;var o=t.getElementsByClassName("cornerstone-canvas");o.length>0&&window.segmentationEnabled&&updateIfActive(e,o[0],t,window.segmentationEnabled),lastMousePosition={x:e.clientX,y:e.clientY,updated:!1}}),$(t).on("mousemove",function(e){if(mouseDown){var o=t.getElementsByClassName("cornerstone-canvas");let n=a(e);!0===updateIfActive(e,o[0],t,n)&&(mouseDown=!1),lastMousePosition={x:e.clientX,y:e.clientY,updated:!0}}}),$(t).on("mouseup",function(e){if(console.log("up "+mouseDown+" "+e.clientX+" "+e.clientY+" "+lastMousePosition.x+" "+lastMousePosition.y+" "+lastMousePosition.updated),mouseDown){var o=t.getElementsByClassName("cornerstone-canvas");let n=a(e);lastMousePosition.x-e.clientX==0&&lastMousePosition.y-e.clientY==0&&1==lastMousePosition.updated||updateIfActive(e,o[0],t,n),mouseDown=!1,lastMove=""}lastMousePosition={x:e.clientX,y:e.clientY,updated:!0}})}function displayThumbnail(t,e,o,a,n){$(t).find(".data-list-items").each(function(){$(this).removeClass("active")}),$(e).addClass("active"),cornerstone.getEnabledElement(o).image&&(cornerstoneTools.stopClip(o),cornerstoneTools.stackScroll.disable(o),cornerstoneTools.stackScroll.enable(o)),cornerstone.loadAndCacheImage(a.imageIds[0]).then(function(t){n&&n.call(t,o,a),viewportHistory.enable(o);var e=cornerstoneTools.getToolState(o,"stack");e.data[0]=a,e.data[0].currentImageIdIndex=0;var s=cornerstone.getDefaultViewport(o,t);cornerstone.displayImage(o,t,s),cornerstone.fitToWindow(o),cornerstoneTools.stackPrefetch.enable(o),void 0!==a.frameRate&&cornerstoneTools.playClip(o,a.frameRate);cornerstoneTools.freehand.setConfiguration({mouseLocation:{handles:{start:{highlight:!0,active:!0}}},keyDown:{shift:!1,ctrl:!1,alt:!1},activePencilMode:!0,spacing:5,activeHandleRadius:3,completeHandleRadius:6,alwaysShowHandles:!1,invalidColor:"crimson",modifying:!1,movingTextBox:!1,currentHandle:0,currentTool:-1,isFreehand:!0,showTextbox:!1}),cornerstoneTools.freehand.enable(o),cornerstoneTools.rectangleRoi.enable(o),$(".data-list li").removeClass("disabled")})}async function loadStudy(t,e,o,a){let n=await loadProjects(o,a);if(200===n.status){window.editorConfig=n.data.editor,window.studyConfig=n.data,window.updateImageSynchronizer=new cornerstoneTools.Synchronizer("cornerstonenewimage",cornerstoneTools.updateImageSynchronizer);let o=n.data.images;if(o.classes=n.data.classes,o.classes){for(var s in o.classes)if(o.classes.hasOwnProperty(s)){var i=o.classes[s];classes.push({class:s,color:i.color})}$("#annotationClasses").empty(),$("#selectedClass").html("Selected Class: None");let t=classes.length>5?5:classes.length;for(var r=0;r<t;r++){let t='<li data-class="'+classes[r].class+'" data-color="'+classes[r].color+'" style="background:'+classes[r].color+'">'+classes[r].class+"</li>";$("#annotationClasses").append(t)}if(editorConfig.selectedClass){let t=classes.find(t=>t.class==editorConfig.selectedClass);t&&($('#annotationClasses li[data-class="'+t.class+'"]').addClass("active"),$('.annts_sel_class_block ul li[data-class="'+t.class+'"]').addClass("active"),$("#selectedClass").html("Selected Class: <span>"+t.class+"</span>"),$("#selectedColor").val(t.color),$("#classSelected").val(t.class),$("#select_annotation_class").attr("data-class",t.class),$("#select_annotation_class").attr("data-color",t.color),$(".ai-form-annotation").css({"background-color":t.color}),$(".ai-form-annotation").html(t.class?t.class:"None"))}if(classes.length>5){let t='<li class="more_ants_btn" style="background: #8e8e8e">More..</li>';$("#annotationClasses").append(t)}for(r=0;r<classes.length;r++){let t='<li data-class="'+classes[r].class+'" data-color="'+classes[r].color+'" style="background:'+classes[r].color+'">'+classes[r].class+"</li>";$(".annts_sel_class_block ul").append(t)}let e='<li class="more_ants_btn" style="background: #8e8e8e">More..</li>';$("#annotationClasses").append(e);for(r=0;r<classes.length;r++){let t='<option value="'+classes[r].class+'">'+classes[r].class+"</option>";$("#export_annotation_class").append(t)}}$(document).on("click","#annotationClasses li",function(){if(!$(this).hasClass("more_ants_btn")){$("#annotationClasses li").removeClass("active"),$(this).addClass("active");let t=$(this).attr("data-class");$('.annts_sel_class_block ul li[data-class="'+t+'"]').addClass("active"),$("#selectedClass").html("Selected Class: <span>"+t+"</span>"),$("#selectedColor").val($(this).attr("data-color")),$("#classSelected").val($(this).attr("data-class")),$(".ai-form-annotation").css({"background-color":$(this).attr("data-color")}),$(".ai-form-annotation").html($(this).attr("data-class")?$(this).attr("data-class"):"None")}}),$(document).on("click",".annts_sel_class_block ul li",function(){$(".annts_sel_class_block ul li").removeClass("active"),$(this).addClass("active");let t=$(this).attr("data-class");$("#select_annotation_class").attr("data-class",t),$("#select_annotation_class").attr("data-color",$(this).attr("data-color"))}),$(document).on("click",".ai-form-annotation, .more_ants_btn",function(){if($("#annotationClasses li.active")){let t=$("#annotationClasses li.active").attr("data-class");$(".annts_sel_class_block ul li").removeClass("active"),$('.annts_sel_class_block ul li[data-class="'+t+'"]').addClass("active")}$(".annts_sel_class_block").show()}),$(document).on("click","#cancel_annotation_class",function(){if($("#annotationClasses li.active")){let t=$("#annotationClasses li.active").attr("data-class");$(".annts_sel_class_block ul li").removeClass("active"),$('.annts_sel_class_block ul li[data-class="'+t+'"]').addClass("active")}$(".annts_sel_class_block").hide()}),$(document).on("click","#select_annotation_class",function(){$("#annotationClasses li").removeClass("active"),$(this).addClass("active");let t=$(this).attr("data-class");$("#selectedColor").val($(this).attr("data-color")),$("#classSelected").val($(this).attr("data-class")),$(".ai-form-annotation").css({"background-color":$(this).attr("data-color")}),$(".ai-form-annotation").html($(this).attr("data-class")?$(this).attr("data-class"):"None"),$('#annotationClasses li[data-class="'+t+'"]').addClass("active"),$("#selectedClass").html("Selected Class: <span>"+t+"</span>"),$(".annts_sel_class_block").hide(),1==window.setGrowthToolClassSelection&&(window.setGrowthToolClassSelection=!1,setAnnotationData($(this).attr("targetelement"),$(this).attr("newdata"),$(this).attr("toolType")))}),$("#ai-study-description").html(o.studyDescription);var l=new ImageViewer(t,e);function d(){$(".viewport").first().addClass("viewport-active"),l.forEachElement(function(t){cornerstone.enable(t),$(t).droppable({drop:function(t,e){var o=e.helper.clone().attr("data-stack-index");m($(this).data("index"),o)}})})}l.setLayout("1x1"),setupButtons(window.segmentationEnabled,l),$(t).find(".grid-select .grid-list").click(function(){$(".data-edit li").removeClass("active");var t=$(this).attr("data-value"),e=[];switch(l.forEachElement(function(o,a,n){isNaN($(o).data("useStack"))||e.push($(o).data("useStack")),"1x1"!==t?viewportHistory.disable(o):viewportHistory.enable(o)}),$(this).attr("data-order-number")){case"1":$(".grid-list").removeClass("active"),$(".grid-list.one").addClass("active"),window.singleLayout=!0;break;case"2":$(".grid-list.one, .grid-list.two").addClass("active"),$(".grid-list.three, .grid-list.four").removeClass("active"),window.singleLayout=!1;break;case"3":$(".grid-list.one, .grid-list.three").addClass("active"),$(".grid-list.two, .grid-list.four").removeClass("active"),window.singleLayout=!1;break;case"4":$(".grid-list").addClass("active"),window.singleLayout=!1}if(l.setLayout(t),"1x1"==t||(window.segmentationEnabled=!1),d(),p(),e.length>0){e=e.slice(0,l.viewports.length);var o=0;e.forEach(function(t){m(o++,t)})}$(this).parents("li").removeClass("active"),$(this).parents(".opt-sub-list").slideUp()});var c=0;o.seriesList.forEach(function(t){var e={seriesDescription:t.seriesDescription,stackId:t.seriesNumber,imageIds:[],instances:[],seriesIndex:c,currentImageIdIndex:0,frameRate:t.frameRate,seriesId:t.seriesId,seriesDescription:t.seriesDescription};if(void 0!==t.numberOfFrames)for(var o=t.numberOfFrames,a=0;a<o;a++){var n=t.instanceList[0].imageId+"?frame="+a;"http"!==n.substr(0,4)&&(n=n),e.imageIds.push(n)}else t.instanceList.forEach(function(t){var o=t.imageId,a=t.instanceId,n=t.cornerstoneAnnotationId,s=[];t.annotations&&(s=t.annotations),e.instances.push({instanceId:a,annotations:s,annotationLoaded:!1,cornerstoneAnnotationId:n}),e.imageIds.push(o)});c++,l.stacks.push(e)});var g=$(t).find(".imageViewer")[0],u=($(g).find(".viewportWrapper")[0],$(".ai-container").find(".left-data")[0]),h=$(t).find(".data-main-images")[0];$(h).width();d();var w=$(t).find(".thumbnails")[0];function m(t,e){l.stacks[e].imageIds[0];var a=l.getElement(t);$(a).data("waiting")&&(l.viewports[t].find(".overlay-text").remove(),$(a).data("waiting",!1)),$(a).data("useStack",e),displayThumbnail(w,$(w).find(".data-list-items")[e],a,l.stacks[e],function(t,e){$(t).data("setup")||(setupViewport(t,e,this),setupViewportOverlays(t,o),$(t).data("setup",!0),setupAnnotationHandler(t))})}function p(){var e=$(t).find(".data-main-images")[0];$(w).height("100%");$(e).height(),$(e).width();$(w).height("100%"),$(u).css({height:"100%"}),$(g).css({height:$(u).height()-$(u).find(".data-options:eq(0)").height()}),l.forEachElement(function(t,e){if(cornerstone.resize(t,!0),$(t).data("waiting")){var o=e.find(".overlay-text");o.length<1&&(o=$('<div class="overlay overlay-text">Please drag a stack onto here to view images.</div>').appendTo(e));var a=e.width()/2,n=e.height()/2;o.css({top:n,left:a-o.width()/2})}}),window.segmentationEnabled&&(console.log("redrawSegmentation"),hideSegmentation(element))}l.stacks.forEach(function(t,e){var o='<li class="data-list-items"oncontextmenu="return false"unselectable="on"onselectstart="return false;"onmousedown="return false;" data-stack-index="'+e+'"><div class="dli-thumb"oncontextmenu="return false"unselectable="on"onselectstart="return false;"onmousedown="return false;"></div><div class="dli-caption"><p>'+t.seriesDescription+"</p></div></li>",a=$(o).appendTo(w),n=$(a).find("div")[0];cornerstone.enable(n),cornerstone.loadAndCacheImage(l.stacks[t.seriesIndex].imageIds[0]).then(function(e){0===t.seriesIndex&&$(a).addClass("active"),cornerstone.displayImage(n,e),$(a).draggable({helper:"clone",scroll:!1,zIndex:"5000"})}),$(a).on("click touchstart",function(){$(".data-list li").removeClass("active"),m(0,e)}).data("stack",e)}),$(window).resize(function(){p()}),p(),l.isSingle()&&m(0,0)}}var getClickOffset=function(t,e){var o=getClickPos(t,e),a=o[0];return 4*(o[1]*canvasForSegmentation.width+a)},getClickPos=function(t,e){var o=e,a=o.getBoundingClientRect(),n=window,s=document.documentElement,i=a.left+(n.pageXOffset||s.scrollLeft)-(s.clientLeft||0),r=a.top+(n.pageYOffset||s.scrollTop)-(s.clientTop||0),l=Math.round((t.pageX-i+o.scrollLeft)*(o.offsetWidth/o.scrollWidth)),d=Math.round((t.pageY-r+o.scrollTop)*(o.offsetHeight/o.scrollHeight));return[l=Math.max(Math.min(l,e.width-1),0),d=Math.max(Math.min(d,e.height-1),0)]},getAnnotationData=function(t,e){let o=$("#classSelected").val();if(!o||""==o)return null;let a=cornerstoneTools.getToolState(t,"stack").data[0],n=a.currentImageIdIndex,s=a.instances[n].annotations;for(var i=0;i<s.length;++i){let t=s[i];if(t.toolName==e){if(t.annotationClass==o)return t}}return null},showClassPickerDialog=async function(t,e,o){window.setGrowthToolClassSelection=!0,$(".annts_sel_class_block").attr("targetelement",t),$(".annts_sel_class_block").attr("newdata",e),$(".annts_sel_class_block").attr("toolType",o),$(".annts_sel_class_block").show()},commitGrowthRegion=function(t){try{let o="2dgrowthtool",a=cornerstoneTools.getToolState(t,"stack").data[0];for(var e=0;e<a.instances.length;++e)null!==growthRegion[e]&&0!==growthRegion[e].length&&updateAnnotationData2(t,o,growthRegionId[e],e,!0)}catch(t){console.log(t)}},saveGrowthRegion=function(t){if(null!==growthRegion&&0!==growthRegion.length)try{let a="2dgrowthtool",n=cornerstoneTools.getToolState(t,"stack").data[0],s=n.currentImageIdIndex,i=$("#classSelected").val();let r=n.instances[s].annotations;for(var e=0;e<r.length;e++)if(r[e].toolName==a){Object.assign({},r[e]);break}for(var o=0;o<n.instances.length;++o){if(null===growthRegion[o])continue;let t=n.instances[o].annotations,s=!1;for(e=0;e<t.length;++e){let n=t[e];if(n.toolName==a){n.annotationClass;i==n.annotationClass&&(n.toolData&&n.toolData.data?0===growthRegion[o].length?n.toolData.data=[]:n.toolData.data=n.toolData.data.concat(growthRegion[o]):(n.toolData={id:uuidv4(),data:growthRegion[o],color:n.selectedColor,fillStyle:hexa2rgba(n.selectedColor,.3)},n.toolDataIndex=cornerstoneTools.getToolState(enabledElement,"2dgrowthtool").data.length-1,n.annotatedOn=Date.now()),cornerstoneTools.removeToolState(enabledElement,"2dgrowthtool",n.toolData),cornerstoneTools.addToolState(enabledElement,"2dgrowthtool",n.toolData),updateAnnotationData2(enabledElement,a,n.toolData.id,o,!1),growthRegionId[o]=n.toolData.id,s=!0)}}if(!s){let e={id:uuidv4(),data:growthRegion[o],color:(void 0).selectedColor,fillStyle:hexa2rgba((void 0).selectedColor,.3)};cornerstoneTools.addToolState(enabledElement,"2dgrowthtool",e),(void 0).toolDataIndex=cornerstoneTools.getToolState(enabledElement,"2dgrowthtool").data.length-1,(void 0).toolData=e,(void 0).annotatedOn=Date.now(),t.push(void 0),updateAnnotationData2(enabledElement,a,(void 0).toolData.id,o,!0),growthRegionId[o]=annotation.toolData.id}}}catch(t){console.log(t)}},clearGrowthRegion=function(t){if(null===growthRegion||0===growthRegion.length)return;let e=cornerstoneTools.getToolState(t,"stack").data[0];for(var o=0;o<e.instances.length;++o)deleteAnnotation1("2dgrowthtool",growthRegionId[o],o,!1);growthRegion=null,growthRegionId=null},displayAnnotationData=function(t,e,o,a,n,s){for(var i=0;i<e.length;i++){let l=e[i][0],d=e[i][1];var r=d*annImageData.width+l;r*=4,a.includes(r)||(a.push(r),t[r+0]==s.r&&t[r+1]==s.g&&t[r+2]==s.b||!n?t[r+0]==s.r&&t[r+1]==s.g&&t[r+2]==s.b&&(t[r+3]=128,o.push([l,d])):(t[r+0]=s.r,t[r+1]=s.g,t[r+2]=s.b,t[r+3]=128,o.push([l,d])))}return t};const growAnnotation=function(t,e,o,a,n,s){var i=getAnnotationData(o,"2dgrowthtool"),r={r:255,g:0,b:0},l=[];i&&i.toolData?(l=i.toolData.data,r=hexToRGB(i.selectedColor)):(l=[],r={r:255,g:0,b:0});let d=cornerstoneTools.getToolState(o,"stack").data[0].currentImageIdIndex;var c=getClickPos(t,e),g=cornerstone.canvasToPixel(o,{x:c[0],y:c[1]});g.x=Math.floor(g.x),g.y=Math.floor(g.y);var u=[];u.push([g.x,g.y]);let h=generateGrowthRegion(u,a);if(3===a&&growthRegion&&h.length===growthRegion.length){for(var w=0;w<growthRegion.length;w++)n?growthRegion[w]=growthRegion[w].concat(h[w]):d!==w&&(growthRegion[w]=[]);saveGrowthRegion(o)}else growthRegion=h,growthRegionId=new Array(growthRegion.length);if(null===growthRegion[d]||0===growthRegion[d].length)return!1;var m=[],p=[];if(n)l=l.concat(growthRegion[d]),growthImageData.data.set(displayGrowthData(growthImageData.data,l,m,p,r,n));else{growthImageData.data.set(displayGrowthData(growthImageData.data,growthRegion[d],[],p,r,n));for(w=0;w<l.length;w++){let t=l[w][0];var f=l[w][1]*growthImageData.width+t;f*=4,p.includes(f)||m.push(l[w])}}if(contextGrowth.putImageData(growthImageData,0,0),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")),s(),!i&&n){let t=uuidv4(),e=0,a=cornerstoneTools.getToolState(o,"2dgrowthtool");a&&a.data.length>0&&("block"===$(".create-annotation-block")[0].style.display?(e=a.data.length-1,t=a.data[e].id,m=a.data[e].data.concat(m)):e=a.data.length);let n={id:t,data:m};return a&&e!==a.data.length||cornerstoneTools.addToolState(o,"2dgrowthtool",n),$(".create-annotation-block").attr("tool-type","2dgrowthtool"),$(".create-annotation-block").attr("tool-data-index",e),$(".create-annotation-block").slideDown(),!0}{let t=$("#classSelected").val();if(t&&""!=t){i.toolData.data=m;let t=cornerstoneTools.getToolState(o,"2dgrowthtool");for(w=0;w<t.data.length;++w)if(t.data[w].id===i.toolData.id){t.data[w].data=m;break}updateAnnotationData(o,"2dgrowthtool",i.toolData.id)}else showClassPickerDialog(o,toolData,"2dgrowthtool")}return!1};var boolIsUpdating=0,updateIfActive=function(t,e,o,a){if(!window.segmentationEditable)return!1;try{if($("#growthtool3d").hasClass("active")){return growAnnotation(t,e,o,3,a,function(){$("#loader").hasClass("hide")||$("#loader").addClass("hide")})}if($("#growthtool").hasClass("active")){return growAnnotation(t,e,o,2,a,function(){$("#loader").hasClass("hide")||$("#loader").addClass("hide")})}if(!segmentedData)return!1;var n=getClickOffset(t,e),s=_getEncodedLabel(superpixel,n),i=pixelIndex[s],r=annImageData.data;annotation=getAnnotationData(o,"2dgrowthtool"),annotation?(oldGrowthToolData=annotation.toolData.data,drawColor=hexToRGB(annotation.selectedColor)):(oldGrowthToolData=[],drawColor={r:255,g:0,b:0}),newGrowthToolData=[];var l=[];if(this.currentPixels=i,null!==this.currentPixels){for(h=0;h<i.length;++h){var d=(n=i[h])/4%segmentedData.imageData.width,c=Math.floor(n/4/segmentedData.imageData.width),g=cornerstone.canvasToPixel(o,{x:d,y:c});g.x=Math.floor(g.x),g.y=Math.floor(g.y);var u=g.y*annImageData.width+g.x;u*=4,l.includes(u)||(l.push(u),r[u+0]==drawColor.r&&r[u+1]==drawColor.g&&r[u+2]==drawColor.b||!a||(r[u+0]=drawColor.r,r[u+1]=drawColor.g,r[u+2]=drawColor.b,r[u+3]=128,newGrowthToolData.push([g.x,g.y])),r[u+0]==drawColor.r&&r[u+1]==drawColor.g&&r[u+2]==drawColor.b&&a&&(r[u+3]=128,newGrowthToolData.push([g.x,g.y])),r[u+0]!=drawColor.r||r[u+1]!=drawColor.g||r[u+2]!=drawColor.b||a||(r[u+0]=0,r[u+1]=0,r[u+2]=0,r[u+3]=0))}r=displayAnnotationData(r,oldGrowthToolData,newGrowthToolData,l,!0,drawColor),annImageData.data.set(r),contextAnnotation.putImageData(annImageData,0,0),svgimgann.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png"));let t={id:uuidv4(),data:newGrowthToolData};if(!annotation){let t=uuidv4(),e=0,a=cornerstoneTools.getToolState(o,"2dgrowthtool");a&&a.data.length>0&&("block"===$(".create-annotation-block")[0].style.display?(e=a.data.length-1,t=a.data[e].id,newGrowthToolData=a.data[e].data.concat(newGrowthToolData)):e=a.data.length);let n={id:t,data:newGrowthToolData};return a&&e!==a.data.length||cornerstoneTools.addToolState(o,"2dgrowthtool",n),$(".create-annotation-block").attr("tool-type","2dgrowthtool"),$(".create-annotation-block").attr("tool-data-index",e),$(".create-annotation-block").slideDown(),!0}{let e=$("#classSelected").val();if(e&&""!=e){annotation.toolData.data=newGrowthToolData;let t=cornerstoneTools.getToolState(o,"2dgrowthtool");for(var h=0;h<t.data.length;++h)if(t.data[h].id===annotation.toolData.id){t.data[h].data=newGrowthToolData;break}updateAnnotationData(o,"2dgrowthtool",annotation.toolData.id)}else showClassPickerDialog(o,t,"2dgrowthtool")}}}catch(t){console.log(t)}return console.log("return2 false"),!1};function _getEncodedLabel(t,e){return t[e]|t[e+1]<<8|t[e+2]<<16}function redrawSegmentation(t,e){try{var o=t.getElementsByClassName(e);if(o.length>0?((o=o[0]).setAttributeNS(null,"visibility","hidden"),o.parentElement.removeChild(o),o=null):o=null,!o){if(!(a=t.getElementsByClassName("cornerstone-canvas"))||0==a.length)return;var a,n=a[0].width,s=a[0].height,i=(a=cornerstone.getEnabledElement(t).canvas).getContext("2d").getImageData(0,0,n,s);segmentedData=drawSegmentation(i,25),(o=document.createElementNS("http://www.w3.org/2000/svg","svg")).setAttributeNS(null,"id",e),o.setAttributeNS(null,"viewBox","0 0 "+n+" "+s),o.setAttributeNS(null,"width",n),o.setAttributeNS(null,"height",s),$(o).css({position:"absolute",top:"0px",left:"0px"}),$(o).addClass("segmentationsvg"),canvasForSegmentation=document.createElement("canvas"),contextSegmentation=canvasForSegmentation.getContext("2d"),canvasForSegmentation.width=segmentedData.result.width,canvasForSegmentation.height=segmentedData.result.height,contextSegmentation.putImageData(segmentedData.imageData,0,0),(svgimg=document.createElementNS("http://www.w3.org/2000/svg","image")).setAttributeNS(null,"preserveAspectRatio","none"),svgimg.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForSegmentation.toDataURL("image/png")),o.append(svgimg),o.setAttributeNS(null,"visibility","visible"),$(t).append(o)}}catch(t){console.log(t.message)}}function setupGrowthToolLawyer(t,e,o){try{var a=t.getElementsByClassName("cornerstone-canvas");if(!a||0==a.length)return;var n=a[0].height,s=a[0].width,i=cornerstone.getEnabledElement(t),r=i.viewport.displayedArea.tlhc.x,l=i.viewport.displayedArea.tlhc.y,d=i.viewport.displayedArea.brhc.x-r+1,c=i.viewport.displayedArea.brhc.y-l+1,g=i.viewport.scale;isNaN(g)&&(g=1),d*=g,c*=g,r=Math.floor(r+(s-d)/2),l=Math.floor(l+(n-c)/2),r+=i.viewport.translation.x*g,l+=i.viewport.translation.y*g;var u=t.getElementsByClassName("growthtool-svg");if((u=u[0]).setAttributeNS(null,"viewBox","0 0 "+d+" "+c),u.setAttributeNS(null,"width",d),u.setAttributeNS(null,"height",c),$(u).css({position:"absolute",top:l+"px",left:r+"px"}),canvasForGrowth){if(e){growthImageData=contextGrowth.getImageData(0,0,canvasForGrowth.width,canvasForGrowth.height);let t=displayGrowthData(growthImageData.data,e,[],[],hexToRGB(o),!0);growthImageData.data.set(t),contextGrowth.putImageData(growthImageData,0,0),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")),u.append(svgimggrowth)}}else canvasForGrowth=document.createElement("canvas"),contextGrowth=canvasForGrowth.getContext("2d"),canvasForGrowth.width=i.image.width,canvasForGrowth.height=i.image.height,growthImageData=contextGrowth.createImageData(canvasForGrowth.width,canvasForGrowth.height),e&&growthImageData.data.set(displayGrowthData(growthImageData.data,e,[],[],hexToRGB(o),!0)),contextGrowth.putImageData(growthImageData,0,0),(svgimggrowth=document.createElementNS("http://www.w3.org/2000/svg","image")).setAttributeNS(null,"preserveAspectRatio","none"),svgimggrowth.setAttributeNS(null,"height","100%"),svgimggrowth.setAttributeNS(null,"width","100%"),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")),u.append(svgimggrowth);u.setAttributeNS(null,"visibility","visible")}catch(t){console.log(t.message)}}var displayGrowthData=function(t,e,o,a,n,s){try{for(var i=0;i<e.length;i++){let l=e[i][0],d=e[i][1];var r=d*growthImageData.width+l;r*=4,a.includes(r)||(a.push(r),t[r+0]==n.r&&t[r+1]==n.g&&t[r+2]==n.b||!s?t[r+0]==n.r&&t[r+1]==n.g&&t[r+2]==n.b&&s&&(t[r+3]=128,o.push([l,d])):(t[r+0]=n.r,t[r+1]=n.g,t[r+2]=n.b,t[r+3]=128,o.push([l,d])),s||(t[r+0]=0,t[r+1]=0,t[r+2]=0,t[r+3]=0))}}catch(t){console.log(t)}return t};function setupAnnotationLayer(t,e,o){setupGrowthToolLawyer(t,e,o),contextAnnotation=contextGrowth,svgimgann=svgimggrowth,annImageData=growthImageData,canvasForAnnotation=canvasForGrowth}function hexToRGB(t){var e=t.match(/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i);return{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}}async function updateSegmentationColor(t,e){let o=hexToRGB(t);annData=annImageData.data;for(var a=0;a<e.length;a++){let t=e[a][0];var n=e[a][1]*annImageData.width+t;n*=4,annData[n+0]=o.r,annData[n+1]=o.g,annData[n+2]=o.b}annImageData.data.set(annData),contextAnnotation.putImageData(annImageData,0,0),svgimgann.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png"))}async function clearAnnotation(t,e){let o="",a="";"segmentationtool"===t?(a=annImageData.data,o=annImageData.width):"2dgrowthtool"===t&&(a=growthImageData.data,o=growthImageData.width);for(var n=0;n<e.data.length;n++){let t=e.data[n][0];var s=e.data[n][1]*o+t;a[(s*=4)+3]=0}"segmentationtool"===t?(annImageData.data.set(a),contextAnnotation.putImageData(annImageData,0,0),svgimgann.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png"))):"2dgrowthtool"===t&&(growthImageData.data.set(a),contextGrowth.putImageData(growthImageData,0,0),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")))}async function updateGrowthColor(t,e){let o=hexToRGB(t),a=growthImageData.data;for(var n=0;n<e.length;n++){let t=e[n][0];var s=e[n][1]*growthImageData.width+t;a[(s*=4)+0]=o.r,a[s+1]=o.g,a[s+2]=o.b}growthImageData.data.set(a),contextGrowth.putImageData(growthImageData,0,0),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png"))}function toggleSegmentation(t=!0){$("#segmentation").removeClass("active"),$("#growthtool").removeClass("active"),$(".opt-sub-list").slideUp();var e,o="segmentationsvg";(e=document.getElementById(o))&&(t?e.setAttributeNS(null,"visibility","hidden"):e.setAttributeNS(null,"visibility","visible")),o="segmentationsvg-annotation",(e=document.getElementById(o))&&(t?e.setAttributeNS(null,"visibility","hidden"):e.setAttributeNS(null,"visibility","visible")),o="growthtool-svg",(e=document.getElementById(o))&&(t?e.setAttributeNS(null,"visibility","hidden"):e.setAttributeNS(null,"visibility","visible"))}function setupButtonOnNewImage(t){if($("#growthtool3d").hasClass("active")){hideSegmentation(t,!0),setupGrowthToolLawyer(t,null,null),setConnectedThresholdImageFilterImageIndex(cornerstoneTools.getToolState(t,"stack").data[0].currentImageIdIndex),window.segmentationEditable=!0}else hideSegmentation(t,!0)}function hideSegmentation(t,e=!0){$("#segmentation").removeClass("active"),$("#growthtool").hasClass("active")&&($("#growthtool").removeClass("active"),$(".opt-sub-list").slideUp());var o="";if(o="segmentationsvg",svgElement=t.getElementsByClassName(o),svgElement.length>0&&(svgElement=svgElement[0],svgElement.setAttributeNS(null,"visibility","hidden"),svgElement.parentElement.removeChild(svgElement),svgElement=null),o="segmentationsvg-annotation",svgElement=t.getElementsByClassName(o),svgElement.length>0){svgElement=svgElement[0];let t=svgElement.getElementsByTagName("image");t.length>0&&e&&contextAnnotation&&svgimgann&&canvasForAnnotation&&(svgElement.setAttributeNS(null,"visibility","hidden"),contextAnnotation.clearRect(0,0,annImageData.width,annImageData.height),annImageData=contextAnnotation.getImageData(0,0,annImageData.width,annImageData.height),t[0].setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png")))}if(o="growthtool-svg",svgElement=t.getElementsByClassName(o),svgElement.length>0){svgElement=svgElement[0];let t=svgElement.getElementsByTagName("image");t.length>0&&e&&null!=contextGrowth&&null!=svgimggrowth&&null!=canvasForGrowth&&(svgElement.setAttributeNS(null,"visibility","hidden"),contextGrowth.clearRect(0,0,growthImageData.width,growthImageData.height),growthImageData=contextGrowth.getImageData(0,0,growthImageData.width,growthImageData.height),t[0].setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")))}window.segmentationEnabled=!1,window.segmentationEditable=!1}function setViewportScale(t,e,o){e.scale=o,cornerstone.setViewport(t,e)}function setupButtons(t,e){function o(){forEachViewport(function(t){hideSegmentation(t,!1)})}function a(t){var e=$(".viewportWrapper").find(".viewport-active")[0],o=$("#exportContainer")[0],a=$(o).find("canvas")[0],n=a.getContext("2d");$("#mask_img").is(":checked")&&(n.fillStyle="rgb(0, 0, 0)",n.fillRect(0,0,a.width,a.height)),setTimeout(function(){cornerstoneTools.saveAs(o,"download","image/png"),$(".exp_settings_pop,.menu_list").hide();let t=cornerstoneTools.getToolState(e,"stack").data[0],a=t.instances,n=t.currentImageIdIndex,s=a[n]?a[n]:void 0;if(s){cornerstoneTools.clearToolState(o,"freehand");for(var i=s.annotations,r=0;r<i.length;r++){var l=i[r];cornerstoneTools.addToolState(o,l.toolName,l.toolData)}}},1e3),$("#exportContainer").off("cornerstoneimagerendered")}cornerstoneTools.toolStyle.setToolWidth(1),cornerstoneTools.toolColors.setToolColor("#ffcc33"),cornerstoneTools.toolColors.setActiveColor("rgba(0,255,51,1.0)"),cornerstoneTools.toolColors.setFillColor("#0099ff"),imageViewer1=e,$("#undo").on("click touchstart",function(){forEachViewport(function(t){viewportHistory.undo(t),cornerstone.updateImage(t)})}),$("#redo").on("click touchstart",function(){forEachViewport(function(t){viewportHistory.redo(t),cornerstone.updateImage(t)})}),$("#zoomIn").on("click touchstart",function(){if(o(),$(".data-list li").removeClass("active"),$(".opt-sub-list").slideUp(),$(this).hasClass("disabled"))return!1;disableAllTools(),window.zoomChangeRequest++,forEachViewport(function(t){const e=cornerstone.getViewport(t);e.scale+=.1,cornerstone.setViewport(t,e);const o={element:t};var a=jQuery.Event("cornerstonetoolsaction");a.detail=o,$(t).trigger(a)})}),$("#zoomOut").on("click touchstart",function(){if(o(),$(this).hasClass("disabled"))return!1;$(".data-list li").removeClass("active"),$(".opt-sub-list").slideUp(),disableAllTools(),window.zoomChangeRequest++,forEachViewport(function(t){const e=cornerstone.getViewport(t);e.scale-=.1,cornerstone.setViewport(t,e);const o={element:t};var a=jQuery.Event("cornerstonetoolsaction");a.detail=o,$(t).trigger(a)})}),$("#stackScroll").on("click touchstart",function(){if(o(),$(this).hasClass("disabled"))return!1;forEachViewport(function(t){window.updateImageSynchronizer.remove(t),cornerstoneTools.referenceLines.tool.disable(t,window.updateImageSynchronizer)})}),$("#probe").on("click touchstart",function(){if(o(),$(this).hasClass("disabled"))return!1;disableAllTools(),$(this).hasClass("active")||forEachViewport(function(t){cornerstoneTools.textStyle.setFont("25px Arial"),cornerstoneTools.dragProbe.activate(t,1)})}),$("#pan").on("click touchstart",function(){if(o(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.pan.activate(t,3),cornerstoneTools.panTouchDrag.activate(t),window.panChangeRequest++})}),$("#segmentation").on("click touchstart",function(){if(o(),disableAllTools(),window.singleLayout){window.segmentationEnabled?window.segmentationEnabled=!1:window.segmentationEnabled=!0,window.segmentationEditable=!0,forEachViewport(function(t){1;var e=t.getElementsByClassName("segmentationsvg");(e=e[0])?window.segmentationEnabled?e.setAttributeNS(null,"visibility","visible"):e.setAttributeNS(null,"visibility","hidden"):(redrawSegmentation(t,"segmentationsvg"),setupAnnotationLayer(t,null,null))})}else alert("Segmenation only works in Single view layout!")}),$("#subtractarea").on("click touchstart",function(){o(),disableAllTools(),window.segmentationEnabled&&$("#segmentation").click()}),$("#growthtool").on("click touchstart",function(){o(),disableAllTools(),window.singleLayout?forEachViewport(function(t){var e=cornerstoneTools.getToolState(t,"stack");if(void 0!==e&&void 0!==e.data&&0!==e.data.length){let t=e.data[0];if("http"===t.imageIds[t.currentImageIdIndex].substr(0,4))return void alert("2DGrowth only works for Dicom image format (not for png)!")}hideSegmentation(t,!1);let o=-1*window.growthRange+" to "+window.growthRange;$(".growthrange-range").text(o),$("#growthRange").slider({value:window.growthRange,max:100,slide:function(t,e){let o=-1*parseInt(e.value)+" to "+e.value;$(".growthrange-range").text(o);var a=$("#"+t.target.id).find(".ui-slider-handle").css("left");$(".growthrange-before").css("width",a),window.growthRange=parseInt(e.value),ConnectedThresholdImageFilterRange(window.growthRange,-1*window.growthRange)},change:function(t,e){let o=-1*parseInt(e.value)+" to "+e.value;$(".growthrange-range").text(o);var a=$("#"+t.target.id).find(".ui-slider-handle").css("left");$(".growthrange-before").css("width",a),window.growthRange=parseInt(e.value),ConnectedThresholdImageFilterRange(window.growthRange,-1*window.growthRange)},stop:function(t,e){let o=-1*parseInt(e.value)+" to "+e.value;$(".growthrange-range").text(o),window.growthRange=parseInt(e.value),ConnectedThresholdImageFilterRange(window.growthRange,-1*window.growthRange)}});let a=cornerstoneTools.getToolState(t,"stack").data[0],n=a.currentImageIdIndex;var s=[];(async()=>{await a.imageIds.forEach(function(t){cornerstone.loadImage(t).then(t=>{s.push(t.getPixelData())})});var e=cornerstone.getEnabledElement(t);e&&(e.image.getPixelData(),setupGrowthToolLawyer(t,null,null),initConnectedThresholdImageFilter(s,n,2,e,2),window.segmentationEditable=!0)})()}):alert("2DGrowth Tool only works in Single view layout!")}),$("#growthtool3d").on("click touchstart",function(){o(),disableAllTools(),window.singleLayout?forEachViewport(function(t){var e=cornerstoneTools.getToolState(t,"stack");if(void 0!==e&&void 0!==e.data&&0!==e.data.length){let t=e.data[0];if("http"===t.imageIds[t.currentImageIdIndex].substr(0,4))return void alert("3DGrowth only works for Dicom image format (not for png)!")}hideSegmentation(t,!1);let o=-1*window.growthRange3d+" to "+window.growthRange3d;$(".growthrange3d-range").text(o),$("#growthRange3d").slider({value:window.growthRange3d,max:30,slide:function(t,e){let o=-1*parseInt(e.value)+" to "+e.value;$(".growthrange3d-range").text(o);var a=$("#"+t.target.id).find(".ui-slider-handle").css("left");$(".growthrange3d-before").css("width",a),window.growthRange3d=parseInt(e.value),ConnectedThresholdImageFilterRange(window.growthRange3d,-1*window.growthRange3d)},change:function(t,e){let o=-1*parseInt(e.value)+" to "+e.value;$(".growthrange3d-range").text(o);var a=$("#"+t.target.id).find(".ui-slider-handle").css("left");$(".growthrange3d-before").css("width",a),window.growthRange3d=parseInt(e.value),ConnectedThresholdImageFilterRange(window.growthRange3d,-1*window.growthRange3d)},stop:function(t,e){let o=-1*parseInt(e.value)+" to "+e.value;$(".growthrange3d-range").text(o),window.growthRange3d=parseInt(e.value),ConnectedThresholdImageFilterRange(window.growthRange3d,-1*window.growthRange3d)}});let a=cornerstoneTools.getToolState(t,"stack").data[0],n=a.currentImageIdIndex;var s=[];(async()=>{await a.imageIds.forEach(function(t){cornerstone.loadImage(t).then(t=>{s.push(t.getPixelData())})});var e=cornerstone.getEnabledElement(t);e&&(e.image.getPixelData(),setupGrowthToolLawyer(t,null,null),initConnectedThresholdImageFilter(s,n,2,e,3),window.segmentationEditable=!0)})()}):alert("3DGrowth Tool only works in Single (1x1) view layout!")}),$("#save3dregion").on("click touchstart",function(){forEachViewport(function(t){commitGrowthRegion(t)})}),$("#clear3dregion").on("click touchstart",function(){forEachViewport(function(t){clearGrowthRegion(t)})}),$("#hide").on("click touchstart",function(){$(this).hasClass("active")?toggleSegmentation(!1):toggleSegmentation(!0)}),$("#delete").on("click touchstart",function(){if(o(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.clearToolState(t,"freehand");var e=cornerstoneTools.getToolState(t,"stack");if(void 0!==e&&void 0!==e.data&&0!==e.data.length){let o=e.data[0];o.instances.length>0&&(o.instances[o.currentImageIdIndex].annotations=[],cornerstoneTools.removeToolState(t,"stack",o),cornerstoneTools.addToolState(t,"stack",o),cornerstoneTools.clearToolState(t,"2dgrowthtool"),cornerstoneTools.clearToolState(t,"segmentationtool"),function(){contextAnnotation&&svgimgann&&canvasForAnnotation&&(svgElement.setAttributeNS(null,"visibility","hidden"),contextAnnotation.clearRect(0,0,annImageData.width,annImageData.height),annImageData=contextAnnotation.getImageData(0,0,annImageData.width,annImageData.height),svgimgann.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForAnnotation.toDataURL("image/png")));null!=contextGrowth&&null!=svgimggrowth&&null!=canvasForGrowth&&(contextGrowth.clearRect(0,0,growthImageData.width,growthImageData.height),growthImageData=contextGrowth.getImageData(0,0,growthImageData.width,growthImageData.height),svgimggrowth.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",canvasForGrowth.toDataURL("image/png")))}())}cornerstone.updateImage(t)})}),$("#freehand").on("click",function(){if(o(),$(this).hasClass("disabled"))return!1;disableAllTools();cornerstoneTools.freehand.setConfiguration({mouseLocation:{handles:{start:{highlight:!0,active:!0}}},keyDown:{shift:!1,ctrl:!1,alt:!1},activePencilMode:!0,spacing:5,activeHandleRadius:3,completeHandleRadius:6,alwaysShowHandles:!1,invalidColor:"crimson",modifying:!1,movingTextBox:!1,currentHandle:0,currentTool:-1,isFreehand:!0,showTextbox:!1}),forEachViewport(function(t){cornerstoneTools.freehand.activate(t,1)})}),$("#rectangle").on("click",function(){if(o(),$(this).hasClass("disabled"))return!1;disableAllTools();const t={visible:!1,active:!1,handles:{textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!1,allowedOutsideImage:!1,hasBoundingBox:!1}}};forEachViewport(function(e){cornerstoneTools.addToolState(e,"rectangleRoi",t),cornerstoneTools.rectangleRoi.activate(e,1)})}),$("#brightness").on("click touchstart",function(){if(o(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.wwwc.activate(t,1),cornerstoneTools.wwwcTouchDrag.activate(t)}),forEachViewport(function(t){let e=cornerstone.getViewport(t),o=e.voi.windowWidth;$(".br-range").text(o),$("#brightnessRange").slider({value:o,max:3e3,min:-3e3,slide:function(o,a){$(".br-range").text(a.value);var n=$("#"+o.target.id).find(".ui-slider-handle").css("left");$(".br-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowWidth=parseFloat(a.value),setBrightness(parseFloat(a.value)),cornerstone.setViewport(t,e)},change:function(o,a){$(".br-range").text(a.value);var n=$("#"+o.target.id).find(".ui-slider-handle").css("left");$(".br-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowWidth=parseFloat(a.value),setBrightness(parseFloat(a.value)),cornerstone.setViewport(t,e)},stop:function(e,o){const a={element:t};(e=jQuery.Event("cornerstonetoolsaction")).detail=a,$(t).trigger(e)}})})}),$("#contrast").on("click touchstart",function(){if(o(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.wwwc.activate(t,1),cornerstoneTools.wwwcTouchDrag.activate(t)}),forEachViewport(function(t){let e=cornerstone.getViewport(t),o=e.voi.windowCenter;$(".cr-range").text(o),$("#contrastRange").slider({value:o,max:500,min:-500,slide:function(o,a){$(".cr-range").text(a.value);var n=$("#"+o.target.id).find(".ui-slider-handle").css("left");$(".cr-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowCenter=parseFloat(a.value),setContrast(parseFloat(a.value)),cornerstone.setViewport(t,e)},change:function(o,a){$(".cr-range").text(a.value);var n=$("#"+o.target.id).find(".ui-slider-handle").css("left");$(".cr-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowCenter=parseFloat(a.value),setContrast(parseFloat(a.value)),cornerstone.setViewport(t,e)},stop:function(e,o){const a={element:t};(e=jQuery.Event("cornerstonetoolsaction")).detail=a,$(t).trigger(e)}})})}),$("#wlwc").on("click touchstart",function(){if(o(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){cornerstoneTools.wwwc.activate(t,1),cornerstoneTools.wwwcTouchDrag.activate(t);let e=cornerstone.getViewport(t),o=e.voi.windowWidth,a=e.voi.windowCenter;$(".ww-range").text(o),$(".wc-range").text(a),$("#windowWidthRange").slider({value:o,max:3e3,min:-3e3,slide:function(o,a){$(".ww-range").text(a.value);var n=$("#"+o.target.id).find(".ui-slider-handle").css("left");$(".ww-before").css("width",n),e=cornerstone.getViewport(t),(e=cornerstone.getViewport(t)).voi.windowWidth=parseFloat(a.value),setBrightness(parseFloat(a.value)),cornerstone.setViewport(t,e)},change:function(o,a){$(".ww-range").text(a.value);var n=$("#"+o.target.id).find(".ui-slider-handle").css("left");$(".ww-before").css("width",n),e=cornerstone.getViewport(t),(e=cornerstone.getViewport(t)).voi.windowWidth=parseFloat(a.value),setBrightness(parseFloat(a.value)),cornerstone.setViewport(t,e)},stop:function(e,o){const a={element:t};(e=jQuery.Event("cornerstonetoolsaction")).detail=a,$(t).trigger(e)}}),$("#windowCenterRange").slider({value:a,max:500,min:-500,slide:function(o,a){$(".wc-range").text(a.value);var n=$("#"+o.target.id).find(".ui-slider-handle").css("left");$(".wc-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowCenter=parseFloat(a.value),setContrast(parseFloat(a.value)),cornerstone.setViewport(t,e)},change:function(o,a){$(".wc-range").text(a.value);var n=$("#"+o.target.id).find(".ui-slider-handle").css("left");$(".wc-before").css("width",n),(e=cornerstone.getViewport(t)).voi.windowCenter=parseFloat(a.value),setContrast(parseFloat(a.value)),cornerstone.setViewport(t,e)},stop:function(e,o){const a={element:t};(e=jQuery.Event("cornerstonetoolsaction")).detail=a,$(t).trigger(e)}})})}),$("#invert").on("click touchstart",function(){if(o(),$(".data-list li").removeClass("active"),$(".opt-sub-list").slideUp(),$(this).hasClass("disabled"))return!1;disableAllTools(),forEachViewport(function(t){var e=cornerstone.getViewport(t);!0===e.invert?e.invert=!1:e.invert=!0,cornerstone.setViewport(t,e);const o={element:t};var a=jQuery.Event("cornerstonetoolsaction");a.detail=o,$(t).trigger(a)})}),$("#download").on("click touchstart",function(){o(),$(".exp_settings_pop").show()}),$(".export_btn").on("click touchstart",function(){$(".menu_list ul").show(),disableAllTools();var t=$("#exportContainer")[0];cornerstone.enable(t);var e=$(t).find("canvas")[0],o=$(".viewportWrapper").find(".viewport-active")[0],n=cornerstone.getEnabledElement(o);const s=Object.assign({},n.viewport);delete s.scale,s.translation={x:0,y:0};let i=cornerstoneTools.getToolState(o,"stack").data[0],r=i.instances,l=i.currentImageIdIndex,d=r[l]?r[l]:void 0;$("#exportContainer").on("cornerstoneimagerendered",a),cornerstone.loadImage(n.image.imageId).then(o=>{cornerstone.displayImage(t,o),cornerstone.setViewport(t,s),cornerstone.resize(t,!0);const a=o.width,n=o.height;if($(t).width(a),$(t).height(n),e.width=a,e.style.width=`${a}px`,e.height=n,e.style.height=`${n}px`,cornerstone.fitToWindow(t),cornerstoneTools.clearToolState(t,"freehand"),d){$("#export_annotation_class").val();for(var i=d.annotations,r=0;r<i.length;r++)i[r]}cornerstone.updateImage(t),$("#hide_annts").is(":checked")?(cornerstoneTools.freehand.disable(t),cornerstoneTools.rectangleRoi.disable(t)):(cornerstoneTools.freehand.enable(t),cornerstoneTools.rectangleRoi.enable(t))})})}function disableAllTools(){forEachViewport(function(t){console.log("disableAllTools"),cornerstoneTools.wwwc.disable(t),cornerstoneTools.pan.deactivate(t,2),cornerstoneTools.zoom.deactivate(t,4),cornerstoneTools.dragProbe.deactivate(t,1),cornerstoneTools.freehand.deactivate(t,1),cornerstoneTools.angle.deactivate(t,1),cornerstoneTools.ellipticalRoi.deactivate(t,1),cornerstoneTools.rectangleRoi.deactivate(t,1),cornerstoneTools.stackScroll.deactivate(t,1),cornerstoneTools.wwwcTouchDrag.deactivate(t),cornerstoneTools.zoomTouchDrag.deactivate(t),cornerstoneTools.panTouchDrag.deactivate(t),cornerstoneTools.stackScrollTouchDrag.deactivate(t),cornerstoneTools.rectangleRoi.deactivate(t,1)})}function forEachViewport(t){var e=$(".viewport");$.each(e,function(e,o){var a=o;try{t(a)}catch(t){}})}ImageViewer=function(t,e){var o=this;o.root=t,o.stacks=[],o.viewports=[],o.layout="1x1",o.viewportModel=e,o.setLayout=function(t){o.layout=t;var e=o.getRowsCols(),a=e[0],n=e[1],s=a*n,i=100/n,r=100/a;o.root.find(".imageViewer").html("");var l=0;for(o.viewports=[];l<s;){var d=o.viewportModel.clone().css({width:i+"%",height:r+"%"}).appendTo(o.root.find(".imageViewer"));d.find(".viewport").data("index",l).data("waiting",!0),o.viewports.push(d),l++}},o.getRowsCols=function(){var t=o.layout.split(/x/);return[parseInt(t[0]),parseInt(t[1])]},o.isSingle=function(){return"1x1"==o.layout},o.getElement=function(t){return o.viewports[t].find(".viewport")[0]},o.forEachElement=function(t){o.viewports.forEach(function(e,a){t.call(o,e.find(".viewport")[0],e,a)})}};const loadTemplate=async t=>{var e=$("</div>"),o=await axios.get(t);if(200===o.status){var a=$.parseHTML(o.data);$.each($(a),function(t,o){if("DIV"===o.nodeName)return e=$(o),!1})}return e};function setupViewportOverlays(t,e){var o=$(t).parent(),a=$(o).find(".overlay"),n=$(a[0]).find("div"),s=$(a[1]).find("div"),i=$(a[2]).find("div"),r=$(a[3]).find("div");$(n[0]).text(e.patientName),$(n[1]).text(e.patientId),$(s[1]).text(e.studyDate),$(t).on("cornerstonenewimage",function(e,o){var a=cornerstoneTools.getToolState(t,"playClip");void 0!==a&&a.data.length>0&&void 0!==a.data[0].intervalId&&void 0!==o.frameRate?$(i[0]).text("FPS: "+Math.round(o.frameRate)):$(i[0]).text().length>0&&$(i[0]).text("");var n=cornerstoneTools.getToolState(t,"stack");if(void 0!==n&&void 0!==n.data&&0!==n.data.length){var r=n.data[0];$(i[2]).text("Image # "+(r.currentImageIdIndex+1)+"/"+r.imageIds.length),$(s[2]).text(function(t){let e=t.split("/");if(lastSegment=e[e.length-1],lastSegment=lastSegment.substring(0,lastSegment.lastIndexOf(".")),lastSegment.length>15){let t=lastSegment.substring(0,4)+"..."+lastSegment.substring(lastSegment.length-1-4,lastSegment.length);lastSegment=t}return lastSegment}(r.imageIds[r.currentImageIdIndex])),$(s[0]).text(r.seriesDescription),setupButtonOnNewImage(t),handleAnnotationOnImageIndexChange(t,r)}}),window.updateImageSynchronizer.add(t),cornerstoneTools.referenceLines.tool.enable(t,window.updateImageSynchronizer),$(t).on("cornerstoneimagerendered",function(e){var o=e.detail;if($(r[0]).text("Zoom:"+o.viewport.scale.toFixed(2)),$(r[1]).text("WW/WL:"+Math.round(o.viewport.voi.windowWidth)+"/"+Math.round(o.viewport.voi.windowCenter)),void 0===o.renderTimeInMs||isNaN(o.renderTimeInMs)||$(i[1]).text("Render Time:"+o.renderTimeInMs.toFixed(2)+" ms"),window.zoomChangeRequest>0){window.zoomChangeRequest=0,hideSegmentation(t,!0);var a=cornerstoneTools.getToolState(t,"stack");if(void 0===a||void 0===a.data||0===a.data.length)return;var n=a.data[0];handleAnnotationOnImageIndexChange(t,n)}}),$(t).on("cornerstonetoolsmousedrag",function(e){if(e.detail&&$("#pan").hasClass("active")){window.panChangeRequest=0,hideSegmentation(t,!0);var o=cornerstoneTools.getToolState(t,"stack");if(void 0===o||void 0===o.data||0===o.data.length)return;var a=o.data[0];handleAnnotationOnImageIndexChange(t,a)}})}var baseURL=BASE_URL,taskId=0,projectId=0;function resizeMain(){var t=$(window).height();$(".ai-container").height(t-80)}function createImageData(t,e){var o=document.createElement("canvas"),a=o.getContext("2d").createImageData(t,e);return a.parentcanvas=o,a}function BaseSegmentation(t,e){if(!(t instanceof ImageData))throw"Invalid ImageData";this.imageData=createImageData(t.width,t.height),this.imageData.data.set(t.data)}function SLIC(t,e){BaseSegmentation.call(this,t,e),e=e||{},this.regionSize=e.regionSize||16,this.minRegionSize=e.minRegionSize||Math.round(.8*this.regionSize),this.maxIterations=e.maxIterations||10,this._compute()}function rgb2xyz(t,e,o){for(var a=new Float32Array(3*e*o),n=0;n<e*o;n++){var s=.00392156862*t[4*n+0],i=.00392156862*t[4*n+1],r=.00392156862*t[4*n+2];s=Math.pow(s,2.2),i=Math.pow(i,2.2),r=Math.pow(r,2.2),a[n]=.488718*s+.31068*i+.200602*r,a[n+e*o]=.176204*s+.812985*i+.0108109*r,a[n+2*e*o]=.0102048*i+.989795*r}return a}function xyz2lab(t,e,o){function a(t){return t>.00856?Math.pow(t,.33333333):7.78706891568*t+.1379310336}for(var n=new Float32Array(3*e*o),s=0;s<e*o;s++){var i=a(1*t[s]),r=a(1*t[e*o+s]),l=a(.9999999999999996*t[2*e*o+s]);n[s]=116*r-16,n[s+e*o]=500*(i-r),n[s+2*e*o]=200*(r-l)}return n}function computeEdge(t,e,o,a){for(var n=0;n<3;n++)for(var s=1;s<a-1;s++)for(var i=1;i<o-1;i++){var r=t[n*o*a+s*o+i-1],l=t[n*o*a+s*o+i+1],d=t[n*o*a+(s+1)*o+i],c=t[n*o*a+(s-1)*o+i];e[s*o+i]+=Math.pow(r-l,2)+Math.pow(d-c,2)}}function initializeKmeansCenters(t,e,o,a,n,s,i,r,l){for(var d,c,g=0,u=0,h=0;h<s;h++)for(var w=0;w<n;w++){var m,p,f=0,v=0,$=1/0;for(d=parseInt(Math.round(i*(w+.5)),10),c=parseInt(Math.round(i*(h+.5)),10),d=Math.max(Math.min(d,r-1),0),c=Math.max(Math.min(c,l-1),0),p=Math.max(0,c-1);p<=Math.min(l-1,c+1);++p)for(m=Math.max(0,d-1);m<=Math.min(r-1,d+1);++m){var I=e[p*r+m];I<$&&($=I,f=m,v=p)}o[g++]=parseFloat(f),o[g++]=parseFloat(v),o[g++]=t[v*r+f],o[g++]=t[r*l+v*r+f],o[g++]=t[2*r*l+v*r+f],a[u++]=100,a[u++]=i*i}}function computeCenters(t,e,o,a,n,s,i){for(var r,l=0;l<i;l++)for(var d=0;d<s;d++)o[r=e[d+l*s]]++,a[5*r+0]+=d,a[5*r+1]+=l,a[5*r+2]+=t[l*s+d],a[5*r+3]+=t[s*i+l*s+d],a[5*r+4]+=t[2*s*i+l*s+d];for(r=0;r<n;r++){var c=1/Math.max(o[r],1e-8);a[5*r]=a[5*r]*c,a[5*r+1]=a[5*r+1]*c,a[5*r+2]=a[5*r+2]*c,a[5*r+3]=a[5*r+3]*c,a[5*r+4]=a[5*r+4]*c}}function eliminateSmallRegions(t,e,o,a,n){var s,i,r,l,d,c,g,u,h,w,m,p=new Int32Array(o),f=new Int32Array(o),v=new Array(1,-1,0,0),$=new Array(0,0,1,-1);for(d=0;d<o;++d)if(!p[d]){for(i=t[d],l=0,s=0,f[s++]=d,r=i+1,p[d]=i+1,c=d%a,g=Math.floor(d/a),m=0;m<4;m++)w=(u=c+v[m])+(h=g+$[m])*a,0<=u&&u<a&&0<=h&&h<n&&p[w]&&(r=p[w]);for(;l<s;){var I=f[l++];for(c=I%a,g=Math.floor(I/a),m=0;m<4;++m)w=(u=c+v[m])+(h=g+$[m])*a,0<=u&&u<a&&0<=h&&h<n&&0===p[w]&&t[w]===i&&(p[w]=i+1,f[s++]=w)}if(s<e)for(;s>0;)p[f[--s]]=r}for(d=0;d<o;++d)--p[d];for(var b=0;b<o;++b)t[b]=p[b]}function updateClusterParams(t,e,o,a){for(var n=new Float32Array(a.length/2),s=new Float32Array(a.length/2),i=0;i<t.length;i++){var r=t[i];n[r]<e[r]&&(n[r]=e[r],a[2*r+0]=e[r]),s[r]<o[r]&&(s[r]=o[r],a[2*r+1]=o[r])}}function assignSuperpixelLabel(t,e,o,a,n,s,i,r,l,d,c,g){for(var u,h,w=0;w<n.length;++w)n[w]=1/0;for(var m=d,p=0;p<r*l;++p){var f=Math.round(s[5*p+0]),v=Math.round(s[5*p+1]);for(h=Math.max(0,v-m);h<Math.min(g,v+m);++h)for(u=Math.max(0,f-m);u<Math.min(c,f+m);++u){var $=(u-f)*(u-f)+(h-v)*(h-v),I=t[h*c+u]-s[5*p+2],b=t[c*g+h*c+u]-s[5*p+3],x=t[2*c*g+h*c+u]-s[5*p+4],T=I*I+b*b+x*x,C=Math.sqrt(T/i[2*p+0]+$/i[2*p+1]);C<n[h*c+u]&&(n[h*c+u]=C,e[h*c+u]=p)}}for(h=0;h<g;++h)for(u=0;u<c;++u)i[2*e[h*c+u]]<o[h*c+u]&&(i[2*e[h*c+u]]=o[h*c+u]),i[2*e[h*c+u]+1]<a[h*c+u]&&(i[2*e[h*c+u]+1]=a[h*c+u])}function computeResidualError(t,e){for(var o=0,a=0;a<t.length;++a){var n=t[a]-e[a];o+=Math.sqrt(n*n)}return o}function remapLabels(t){for(var e={},o=0,a=0;a<t.length;++a){var n=t[a];void 0===e[n]&&(e[n]=o++),t[a]=e[n]}return o}function encodeLabels(t,e){for(var o=0;o<t.length;++o){var a=Math.floor(t[o]);e[4*o+0]=255&a,e[4*o+1]=a>>>8&255,e[4*o+2]=a>>>16&255,e[4*o+3]=255}}function computeSLICSegmentation(t,e,o,a){var n,s=t.width,i=t.height,r=Math.floor(s/e),l=Math.floor(i/e),d=Math.floor(r*l),c=Math.floor(s*i),g=new Float32Array(c),u=new Array(c),h=new Float32Array(5*d),w=new Float32Array(5*d),m=new Float32Array(2*d),p=new Float32Array(c),f=new Float32Array(c),v=new Float32Array(c),$=xyz2lab(rgb2xyz(t.data,s,i),s,i);computeEdge($,g,s,i),initializeKmeansCenters($,g,h,m,r,l,e,s,i);for(var I=new Int32Array(c),b=0;b<a;++b){for(assignSuperpixelLabel($,I,p,f,v,h,m,r,l,e,s,i),updateClusterParams(I,p,f,m),n=0;n<u.length;++n)u[n]=0;for(n=0;n<w.length;++n)w[n]=0;if(computeCenters($,I,u,w,d,s,i),computeResidualError(h,w)<1e-5)break;for(n=0;n<h.length;++n)h[n]=w[n]}eliminateSmallRegions(I,o,c,s,i);var x=createImageData(s,i);return x.numSegments=remapLabels(I),encodeLabels(I,x.data),x}function drawSegmentation(t,e){var o=new SLIC(t,{regionSize:e});return superpixel=o.result.data.slice(),pixelIndex=createPixelIndex(o.result.data,o.result.numSegments),o.imageData.data.set(getEdgemap(o.result,{foreground:[255,255,255,127],background:[255,255,255,0]})),o}function createPixelIndex(t,e){var o,a=new Array(e),n=t;for(o=0;o<e;++o)a[o]=[];for(o=0;o<n.length;o+=4){a[n[o]|n[o+1]<<8|n[o+2]<<16].push(o)}return a}function getEdgemap(t,e){void 0===e&&(e={});var o,a,n,s=t.data,i=t.width,r=t.height,l=new Uint8Array(t.data),d=e.foreground||[0,0,0],c=e.background||[255,255,255];for(o=0;o<r;++o)for(a=0;a<i;++a){var g=4*(o*i+a),u=s[4*(o*i+a)];if(0===o||0===a||o===r-1||a===i-1||u!==s[4*(o*i+a-1)]||u!==s[4*(o*i+a+1)]||u!==s[4*((o-1)*i+a)]||u!==s[4*((o+1)*i+a)])for(n=0;n<d.length;++n)l[g+n]=d[n];else for(n=0;n<c.length;++n)l[g+n]=c[n]}return l}function _getEncodedLabel(t,e){return t[e]|t[e+1]<<8|t[e+2]<<16}window.onload=(async()=>{$(".data-list li").addClass("disabled"),cornerstoneWADOImageLoader.external.cornerstone=cornerstone,cornerstoneWebImageLoader.external.cornerstone=cornerstone;var t;cornerstoneWADOImageLoader.webWorkerManager.initialize({webWorkerPath:"./../assets/vendor/cornerstone/cornerstoneWADOImageLoaderWebWorker.min.js",taskConfiguration:{decodeTask:{codecsPath:"cornerstoneWADOImageLoaderCodecs.min.js"}}}),t=await loadTemplate("templates/viewport.html"),taskId=GetQueryParameterByName("task"),projectId=GetQueryParameterByName("project"),await loadStudy($(".ai-container"),t,taskId,projectId)}),$(window).resize(function(){resizeMain()}),resizeMain(),document.body.addEventListener("touchmove",function(t){t.preventDefault()}),$(document).on("click touchstart",".viewport",function(){$(".viewport").removeClass("viewport-active"),$(this).addClass("viewport-active")}),$(function(){$("#mycolor").colorpicker({history:!1})}),$(document).on("click",".aid-close",function(){var t=$(this).parents(".ai-dialog").attr("data-close");void 0!==t&&$('[data-source="'+t+'"').removeClass("active"),$(this).parents(".opt-sub-list").slideUp()}),$(document).on("click",".data-edit li",function(){$(this).hasClass("active")?($(".data-edit li").removeClass("active"),0==$(this).find(".opt-sub-list").length&&$(".opt-sub-list").slideUp()):($(".data-edit li").removeClass("active"),$(this).addClass("active"))}),parent.find(".opt-sub-list"),$(document).on("click",".series",function(){if($(this).hasClass("active"))return $(this).removeClass("active"),$(".ai-main-data").find(".left-data").addClass("closed"),!1;$(".ai-main-data").find(".left-data").removeClass("closed"),$(this).addClass("active")}),$(document).on("click",".opt-group",function(){$(".data-edit li").removeClass("active");var t=$(this).parents("li");return t.hasClass("active")?(console.log("is active"),t.find(".opt-sub-list").slideUp(),t.removeClass("active"),!1):t.find(".opt-sub-list").is(":visible")?(t.find(".opt-sub-list").slideUp(),t.removeClass("active"),!1):($(".opt-group").parents("li").removeClass("active"),$(".opt-sub-list").slideUp(),t.find(".opt-sub-list").slideDown(),void t.addClass("active"))}),$(document).on("click",".selected-color",function(){$(".annotation-color-picker").addClass("show")}),$(document).on("click",".go-back",function(){$(".annotation-color-picker").removeClass("show")}),$("#mycolor").on("change.color",function(t,e){$("#selectedColor").attr("value",e),$(".se-cl").css("background",e)}),$(document).on("click",".reset-range",function(){switch(console.log($(this).attr("data-reset")),$(this).parents(".ai-dialog").addClass("ai-transition"),$(this).attr("data-reset")){case"br":$("#brightnessRange").slider({value:0}),$(".br-before").css("width",0),$(".br-range").text("0");break;case"cr":$("#contrastRange").slider({value:0}),$(".cr-before").css("width",0),$(".cr-range").text("0");break;case"growthrange":$("#growthRange").slider({value:0}),$(".growthrange-before").css("width",0),$(".growthrange-range").text("-0 to 0");break;case"growthrange3d":$("#growthRange3d").slider({value:0}),$(".growthrange3d-before").css("width",0),$(".growthrange3d-range").text("-0 to 0");break;case"ww-wc":$("#windowWidthRange, #windowCenterRange").slider({value:0}),$(".wc-before, .ww-before").css("width",0),$(".wc-range, .ww-range").text("0")}setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-abdominal-soft-tissue",function(){console.log($(this).attr("preset-abdominal-soft-tissue")),$("#windowWidthRange").slider({value:400}),$("#windowCenterRange").slider({value:40}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-bone",function(){$("#windowWidthRange").slider({value:3e3}),$("#windowCenterRange").slider({value:550}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-brain",function(){$("#windowWidthRange").slider({value:80}),$("#windowCenterRange").slider({value:35}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-brain-narrow",function(){$("#windowWidthRange").slider({value:40}),$("#windowCenterRange").slider({value:30}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-liver",function(){$("#windowWidthRange").slider({value:200}),$("#windowCenterRange").slider({value:50}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-lung",function(){$("#windowWidthRange").slider({value:1800}),$("#windowCenterRange").slider({value:-600}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".preset-subdural-brain",function(){$("#windowWidthRange").slider({value:200}),$("#windowCenterRange").slider({value:75}),setTimeout(function(){$(".ai-dialog").removeClass("ai-transition")},500)}),$(document).on("click",".grouped .data-src-img-block",function(){$(".grouped .data-src-img-block").removeClass("active"),$(this).addClass("active")}),$(document).on("click",".menu-icon",function(){$(".menu_list ul").css({"z-index":500}),$(".menu_list").toggle()}),$(document).on("click",".exp_annts",function(){$(this).parents(".menu_list ul").hide(),$(".exp_settings_pop").show()}),$(document).on("click",".exp_settings_pop .aid-close",function(){$(".exp_settings_pop,.menu_list").hide(),$(".menu_list ul").show()}),BaseSegmentation.prototype.finer=function(){},BaseSegmentation.prototype.coarser=function(){},SLIC.prototype=Object.create(BaseSegmentation.prototype),SLIC.prototype.finer=function(){var t=Math.max(5,Math.round(this.regionSize/Math.sqrt(2)));t!==this.regionSize&&(this.regionSize=t,this.minRegionSize=Math.round(.8*t),this._compute())},SLIC.prototype.coarser=function(){var t=Math.min(640,Math.round(this.regionSize*Math.sqrt(2)));t!==this.regionSize&&(this.regionSize=t,this.minRegionSize=Math.round(.8*t),this._compute())},SLIC.prototype._compute=function(){return this.result=computeSLICSegmentation(this.imageData,this.regionSize,this.minRegionSize,this.maxIterations),this.result};var parentElement,inputImages,currentImageIndex,outputImage,diffUpper,diffLower,inputRegionType="",inputPixelType="",inputSizeType="",outputRegionType="",outputPixelType="",outputImageType="",connectivityType="",seeds=[],outputImage1=[],processedOffset=[],nDimensions=3,bytesPerPixel=2,PIXEL_MIN=0,PIXEL_MAX=255,lowerThreshold=PIXEL_MIN,upperThreshold=PIXEL_MAX;function setSeed(t){clearSeeds(),seeds.push(t)}function addSeed(t){seeds.push(t)}function clearSeeds(){seeds=[]}function getSeeds(){return seeds}function setUpperThreshold(t){upperThreshold=t}function setLowerThreshold(t){lowerThreshold=t}function getLowerInput(){}function setUpperInput(){}function getUpperInput(){}function setLowerInput(){}function getLowerInput(){}function setConnectivityType(t){}function getOutputRegion(){return outputRegion}function copyOutputRegionToInputRegion(t,e){e}function generateInputRequestRegion(){copyOutputRegionToInputRegion(inputRegion,getOutputRegion()),setRequestedRegionToLargestPossibleRegion(inputImage)}function setRequestedRegionToLargestPossibleRegion(){outputRegion=outputImage}function enlargeOutputRequestedRegion(t){setRequestedRegionToLargestPossibleRegion(outputImage)}function binaryThresholdImageFilter(t){}var thresholdBelow=function(t){m_lower!=PIXEL_MIN&&m_upper!=t&&(m_lower=PIXEL_MIN,m_upper=t)},thresholdBetween=function(t,e){m_lower!=t&&m_upper!=e&&(m_lower=t,m_upper=e)};function isInside(t,e){if(t[0]>0&&t[0]<width&&t[1]>0&&t[1]<height){if(2===e&&t[2]===currentImageIndex)return!0;let o=Math.max(0,currentImageIndex-3),a=Math.min(inputImages.length,currentImageIndex+3);if(e>2&&t[2]>=o&&t[2]<=a)return!0}return!1}function isPixelIncluded(t){storedPixel=inputImages[t[2]][t[0]+t[1]*width];const e=storedPixel*parentElement.image.slope+parentElement.image.intercept;return e>lowerThreshold&&e<upperThreshold}function floodFilledImageConditionalIterator(t,e){for(var o=function(){try{const u=a[0];for(var t=[],o=0;o<nDimensions;++o)for(var n=-1;n<=1;n+=2){for(var s=[],i=[],r=[],l=0;l<nDimensions;++l)o!=l?(s[l]=u[l],i[l]=u[l]+n,r[l]=u[l]-n):(s[l]=u[l]+n,i[l]=u[l]+n,r[l]=u[l]+n);if(isInside(s,e)){var d=s[1]*width+s[0],c=s[2];if(0==outputImage[c][d])if(isPixelIncluded(s)){if(a.push(s),t.push(s),outputImage[c][d]=2,!processedOffset[c].includes(d)){processedOffset[c].push(d);var g=s.slice(0,2);outputImage1[c].push(g)}}else outputImage[c][d]=1}if(isInside(i,e)){d=i[1]*width+i[0];c=i[2];if(0==outputImage[c][d])if(isPixelIncluded(i)){if(a.push(i),t.push(i),outputImage[c][d]=2,!processedOffset[c].includes(d)){processedOffset[c].push(d);g=i.slice(0,2);outputImage1[c].push(g)}}else outputImage[c][d]=1}if(isInside(r,e)){d=r[1]*width+r[0];c=r[2];if(0==outputImage[c][d])if(isPixelIncluded(r)){if(a.push(r),t.push(r),outputImage[c][d]=2,!processedOffset[c].includes(d)){processedOffset[c].push(d);g=r.slice(0,2);outputImage1[c].push(g)}}else outputImage[c][d]=1}}a.splice(0,1),0==a.length&&!0}catch(t){console.log(t)}},a=[],n=0;n<t.length;++n){const o=t[n][1]*width+t[n][0];var s=t[n][2];isInside(t[n],e)&&isPixelIncluded(t[n])&&(!1,a.push(t[n]),outputImage[s][o]=2)}for(;a.length>0;){const t=a[0][1]*width+a[0][0];s=a[0][2];if(outputImage[s][t]=1,!processedOffset[s].includes(t)){processedOffset[s].push(t);var i=a[0].slice(0,2);outputImage1[s].push(i)}if(outputImage1.length>1e4)break;o()}}function neighborhoodIterator(){var t=[];for(var e=0;e<outputImage1.length;++e){let i=outputImage1[e][0],r=outputImage1[e][1];for(var o=0,a=0,n=-2;n<2;++n)for(var s=-2;s<2;++s){if(r+s<0||r+s>=height||i+n<0||i+n>=width)continue;if(r+s==r&&i+n==i)continue;let t=width*(r+s)+i+n;outputImage[t]>0?o+=1:a+=1}if(o>a){width;t.push([i,r])}}outputImage1=t}function generateGrowthRegion(t,e){try{t.forEach(function(t,e){t.push(currentImageIndex)}),setSeed(t),outputImage=[],outputImage1=[],processedOffset=[];for(var o=0;o<inputImages.length;++o)outputImage.push(new Int16Array(width*height)),outputImage[o].fill(0),outputImage1.push([]),processedOffset.push([]);storedPixel=cornerstone.getStoredPixels(parentElement.element,t[0][0],t[0][1],1,1);const a=storedPixel[0]*parentElement.image.slope+parentElement.image.intercept;upperThreshold=a+diffUpper,lowerThreshold=a+diffLower,floodFilledImageConditionalIterator(t,e)}catch(t){console.log(t)}return outputImage1}function ConnectedThresholdImageFilterRange(t,e){diffLower=e,diffUpper=t}function setConnectedThresholdImageFilterImageIndex(t){currentImageIndex=t}function initConnectedThresholdImageFilter(t,e,o,a,n){try{inputImages=t,currentImageIndex=e,parentElement=a,2===n?(diffUpper=window.growthRange,diffLower=-1*window.growthRange):(diffUpper=window.growthRange3d,diffLower=-1*window.growthRange3d),bytesPerPixel=o,width=parentElement.image.width,height=parentElement.image.height}catch(t){console.log(t)}}